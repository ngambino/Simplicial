\documentclass[reqno,10pt,a4paper,oneside,draft]{amsart}
\setcounter{tocdepth}{1}
\usepackage{../Auxiliary/prelude}
\input{../Auxiliary/prooftree}


\title[]{Constructive aspects of simplicial homotopy theory}

\begin{document}

\begin{abstract}
We establish constructive counterparts of all the main results of simplicial homotopy theory
used in the definition of Voevodsky's simplicial model of univalent foundations. In particular, we
show that the weak factorisation system of trivial cofibrations and Kan fibrations satisfies the 
Frobenius property, that the model structure satisfies the weak equivalence extension property
for weak equivalences between fibrations with cofibrant domain and that there exists a univalent 
 fibration with fibrant base that classifies fibrations with cofibrant domain.
\end{abstract}

\author{Nicola Gambino}
\address{School of Mathematics, University of Leeds, Leeds LS2 9JT, United Kingdom}
\email{n.gambino@leeds.ac.uk}


\author{Simon Henry}
\address{Department of Mathematics and Statistics, Masaryk University, Brno, Czeck Republic}
\email{henrys@math.muni.cz} 


 \date{\today}
 
 

\maketitle

\tableofcontents

\newpage

\section*{Introduction} 


\subsection*{Context} 
\begin{itemize}
\item The problem
\item Obstructions:
\begin{itemize}
\item Minimal fibrations
\item Exponentiability of Kan complexes
\end{itemize}
\item Progress so far:
\begin{itemize}
\item Coquand and others:  
\begin{itemize}
\item cubical sets
\item uniform fibrations
\item issues: de Morgan version is known not to be equivalent to $\mathbf{Top}$.
\end{itemize}
\item Gambino and Sattler
\begin{itemize}
\item General approach; uniform fibrations
\item Gets $\Pi$-types
\item Issue: if you work algebraically, notion of fibration does not support universe; if you work non-algebraically then assumptions are not known to be constructively valid.
\end{itemize}
\item Sattler: 
\begin{itemize}
\item gets a model structure
\item same issues as Gambino-Sattler. 
\end{itemize}
\end{itemize}
\end{itemize}


\subsection*{Main results}

\begin{itemize}
\item We build on [Henry 2018]
\item General approach
\item The crucial role of cofibrancy
\item We obtain 
\begin{itemize}
\item $\Pi$-types
\item Universe
\item Univalence
\end{itemize}
\item Coherence issues:
\begin{itemize}
\item We consider them seriously
\item But they are a separate issue, left for future work
\end{itemize}
\end{itemize}






We will interpret contexts as bifibrant simplicial sets. In particular,
the empty context will be interpreted as the terminal simplicial set $1$.  Dependent types 
will be interpreted as fibrations $p \co A \to X$ where $X$ is a bifibrant simplicial and $A$ is cofibrant. In particular, types in the empty context will be interpreted as bifibrant simplicial sets. 
This choice is motivated by the fact that, for a bifibrant simplicial set $X$, the slice category~$\SSet_{/X}$ admits a weak model structure in which fibrations and cofibrations are the maps that become fibrations and cofibrations, respectively, in~$\SSet$. Then, bifibrant objects in $\SSet_{/X}$
are exactly the fibrations with codomain $X$ and cofibrant domain.



\begin{table}[htb]
\begin{tabular}{|c|c|c|c|}
\hline
& $\SSet$ & $\SSet$ & $\mathbf{CSet}$   \\ 
& \cite{voevodsky-simplicial-model} & \cite{gambino2017frobenius} & \cite{cohen-et-al:cubicaltt}   \\ \hline \hline 
Dependent type & Kan fibration & Uniform Kan fibration & Uniform Kan fibration \\ 
$\mathsf{Id}$-types & \checkmark & \checkmark  &  \checkmark  \\
$\Pi$-types & \checkmark  & \checkmark  & \checkmark  \\
Universe type & \checkmark  &  $\times$ & \checkmark  \\
Univalence axiom & \checkmark  &   $\times$ & \checkmark  \\ 
Constructive & $\times$ & \checkmark   & \checkmark  \\ 
Equivalent to $\mathbf{Top}$ &  \checkmark  & \checkmark  & $\times$  \\
Coherence & \checkmark   & \checkmark &  \checkmark  \\ 
\hline
\end{tabular}
\medskip
\caption{The univalent foundations whack-a-mole game.} 
\label{tab:whack} 
\end{table}


This paper adds a new column to~\cref{tab:whack}.

\begin{table}[htb]
\begin{tabular}{|c|c|}
\hline
& $\SSet$ \\
 \hline \hline 
 Dependent type & Kan fibration with cofibrant domain \\
 $\mathsf{Id}$-types &   \checkmark  \\
$\Pi$-types  & \checkmark  \\
Universe type & \checkmark  \\
Univalence axiom & \checkmark  \\ 
Constructive & \checkmark  \\ 
Equivalent to $\mathbf{Top}$ & \checkmark  \\
Coherence  &  ? \\ 
\hline
\end{tabular}
\medskip
\caption{The contributions of this paper.} 
\end{table}


When working constructively, fibrations as defined above maintain many of their usual classical properties,
such as stability under pullbacks. However, other properties no longer hold. For example, it is not possible to prove constructively that
for a Kan complex $B$, the simplicial set $B^A$ is a Kan complex for every simplicial set $A$. In order
to remedy this in a constructive setting, one needs some additional decidabilty assumptions, which can be 
conveniently encapsulated in the notion of a cofibration and of a cofibrant object introduced in~\cite[\S 5.1.7]{henry2018wms}. 


 \medskip



\section{Preliminaries} 
\label{sec:preliminaries}

Let $\catE$  be a locally cartesian closed category. For $X \in \catE$ we write $\catE_{/X}$ for the slice category over~$X$. For a map $f \co Y \to X$ in $\catE$, we write $f^* \co \catE_{/X} \to \catE_{/Y}$ 
for the associated pullback functor and denote its action on $p \co A \to X$ as 
\[
\xymatrix{
A[f] \ar[r] \ar[d]_{p[f]} & A \ar[d]^p \\
Y \ar[r]_f & X }
\]
For a map $p \co A \to X$ in $\catE$, pullback along $p$ has both left adjoint, written $\Sigma_p \co \catE_{/A}
\to \catE_{/X}$, and a right adjoint, written $\Pi_p \co \catE_{/A} \to \catE_{/X}$. We refer to these functors
as the \emph{dependent sum} and \emph{dependent product} functors, respectively. Their action on a
map $q \co B \to A$ will be written
\[
 \Sigma_p(q) \co \Sigma_A(B) \to X \, , \quad \Pi_p(q) \co \Pi_A(B) \to X \, ,
 \]
respectively. The left adjoint is defined by composition, so $\Sigma_A(B) \defeq B$ and $\Sigma_p(q) = qp$.

\medskip
For a small category $\mathbb{C}$, we write $\Psh(\mathbb{C})$ for the category of presheaves over $\mathbb{C}$ and $\yon_\mathbb{C} \co \mathbb{C} \to \Psh(\mathbb{C})$ for the Yoneda embedding. 
Recall that, for $c \in \mathbb{C}$, there is an equivalence of categories
\begin{equation}
\label{equ:pshslice}
\Psh(\mathbb{C})_{/ \yon(c)} \simeq \Psh \big(  \mathbb{C}_{/c}  \big )
\end{equation}
For $F \co {\mathbb{C}_{/c}}^{\op} \to \Set$, we write $\pi_1 \co \int F \to \yon(c)$
for the corresponding object of~$\Psh(\mathbb{C})_{/ \yon(c)}$.


\medskip



\medskip




We write $\Delta$ for the simplicial category, the objects of which will be written as $[n]$, for $n \geq 0$,
and $\SSet$ for the category of simplicial sets, defined as usual as the  presheaf category over $\Delta$.
For $n \geq 0$, $\Delta[n] \in \SSet$ is the representable simplicial set associated to $[n] \in \Delta$. As a special case of the equivalence in~\eqref{equ:pshslice}, for every $[n] \in \Delta$ there is an equivalence of categories
\begin{equation}
\label{equ:psh-slice-sset}
\SSet_{/\Delta[n]} \simeq \Psh \big( \Delta_{/[n]} \big ) \, .
\end{equation}
For $[n] \in \Delta$, we write $i^n \co  \partial \Delta[n] \to \Delta[n]$ 
for the \emph{boundary inclusion} into the $n$-simplex and, for $1 \leq k \leq n$,  
$h^k_n  \co \Lambda^k[n] \to \Delta[n]$ 
for the $k$-th \emph{horn inclusion} into the $n$-simplex. 
The simplicial set $\Delta[1]$ is an interval object in $\SSet$, with endpoint inclusions~$\kcyl \co \braces{ k} \to \Delta[1]$ defined by~$\kcyl \defeq h^1_k$. Throughout this paper, we shall work  with the model structure on $\SSet$ for Kan complexes defined in \cite[Section~5]{henry2018wms} using constructively valid arguments. For the convenience of the reader, we recall some
of the main aspects of this model structure.


\medskip

Let $\cal{I}$ be the set of boundary inclusions, \ie $\cal{I} \defeq \{ i^n \co  \partial \Delta[n] \to \Delta[n] \ | \ n \geq 0 \}$.  By the constructive version of the small object argument, which can be applied in this context since the 
maps in $\cal{I}$ satisfy all the finiteness and decidability assumptions discussed  in~\cite[\S 4.1.4]{henry2018wms}, the set~$\cal{I}$ generates a weak factorisation system
\[
\big( \Cof, \TrivFib \big) \defeq ( \mathsf{Sat}(\cal{J}) \, , \cal{J}^\pitchfork)
\]
on $\SSet$. The maps in the left class will be called \myemph{cofibrations} and those in the right
class will be called \myemph{trivial fibrations}. 
As shown in \cite{henry2018wms} a map $f \co Y \to X$ is a cofibration if  and only if 
it is a levelwise complemented monomorphism and the degeneracy of the simplices of $X~\setminus~\mathsf{Im}(f)$ is decidable. A simplicial set $X$ will be said to be~\myemph{cofibrant} if the unique map $0 \to X$ is a cofibration, 
\ie degeneracy of the simplices of $X$ is decidable.
Note that a map between cofibrant objects is a cofibration
if and only if it is a levelwise complemented monomorphism. 
Cofibrant simplicial sets are of particular importance for our development because of their decidability property, which can be used to establish counterparts of classical results valid for all simplicial sets. An example is the Eilenberg-Zilber lemma~\cite{henry2018wms}, asserting that in a cofibrant simplicial set~$X$, any cell $x \in X$ can be written uniquely as $p^*(y)$, where $y$ is a non-degenerate cell of $X$ and $p$ is a degeneracy. Clearly, if one assumes the law of excluded middle, then every monomorphism is a cofibration and our notion of a cofibration coincides with the classical one. 

\medskip

Let $\cal{J}$ be the set of horn inclusions, \ie $\cal{J} \defeq \{ h^k_n  \co \Lambda^k[n] \to \Delta[n]  \ | \ 0 \leq k \leq n \}$. By another application of the constructive version of the small object argument, the set $\cal{J}$
generates a weak factorisation system 
\[
(\TrivCof, \Fib) = ( \mathsf{Sat}(\cal{J}) \, , \cal{J}^\pitchfork)
\] 
on $\SSet$. The maps in the right class will be called \emph{fibrations} and the maps in the left class will be called \emph{trivial cofibrations}. As usual, we say that a simplicial set~$A$ is \myemph{fibrant} if  \ie the unique map~$A \to 1$ is a fibration. For $X \in \SSet$, we write $\Fib_{/X}$ for the full subcategory of the slice category $\SSet_{/X}$ spanned by the fibrations with codomain $X$
We say that a simplicial set is \myemph{bifibrant} if it is both fibrant and cofibrant.  For $X \in \SSet$,
we write $\BFFib_{/X}$ for  the full subcategory of  $\Fib_{/X}$ spanned by fibrations with cofibrant domain.

\medskip

It was shown in~\cite{henry2019qms} that two weak factorisation systems
$(\Cof, \TrivFib)$ and $(\TrivCof, \Fib)$ are part of a model structure on the category $\SSet$.
Furthermore, it was also shown in~\cite{henry2019qms} that the model structure is both 
right proper, \ie pullbacks of weak equivalences along fibrations are again weak equivalences, and
left proper, \ie pushouts of weak equivalences along cofibrations are again weak equivalences.
Let us also recall that
two weak factorization systems $(\Cof, \TrivFib)$ and $(\TrivCof, \Fib)$
satisfy the so-called pushout product property~\cite{henry2018wms}. More precisely, given two maps $f \co Y \rightarrow X$ and $g \co B \rightarrow A$ their \emph{pushout product} $f \hattimes g$ is defined as the unique dotted map in the diagram
\[
\xymatrix{
Y \times B \ar[r] \ar[d] &  X \times B \ar[d] \ar@/^1.5pc/[ddr] \\
Y \times A \ar[r]  \ar@/_1.5pc/[drr] & \displaystyle \big( Y \times A ) +_{Y \times B} \big( X \times B ) \ar@{.>}[dr]  \\
 & & X \times A }
 \]
The pushout-product property is then the statement that:

\begin{itemize}
\item If $f$ and $g$ are cofibrations then so is $f \hattimes g$.
\item If additionally one of $f$ and $g$ is a weak equivalence, then so is $f \hattimes g$.
\end{itemize}
Note that when $f$ and $g$ are monomorphisms, so in particular when they are cofibrations, the pushout in the diagram above is just an union of subobjects and the pushout product of~$f$ and~$g$ is just the inclusion:
\[  
f \hattimes g \co (Y \times A) \cup (X \times B) \rightarrow X \times A \, .
\]
Dually, using  exponentials instead of products and pullbacks instead of pushouts, for maps $f \co Y \rightarrow X$ and~$p \co B \rightarrow A$, the \myemph{pullback exponential}  $\langle f \, , p \rangle$ is defined as the unique dotted arrow in the diagram:
\[
\xymatrix{
 B^X \ar@{.>}[dr] \ar@/^1.5pc/[drr] \ar@/_1.5pc/[ddr] \\
& B^Y \times_{A^Y} A^X \ar[r] \ar[d] &  A^X \ar[d]  \\
& B^Y \ar[r] & A^Y  \\
 }
 \]
It is a very classical observation that an arrow $f$ has the left lifting property agains $\langle p \, , q \rangle $ if and only if $f \hattimes p$ has the left lifting property against $q$:
\[
f \pitchfork \langle p \, , q \rangle \Leftrightarrow f \hattimes p \pitchfork q 
\]
 For a proof, see the appendix of \cite{joyal-tierney-segal}, for example. The pushout-property immediately implies its dual version: 
\begin{itemize}
\item if $f \co Y \to X$ is a cofibration and $p \co B \to A$ a fibration then $\langle f \, , p \rangle$ is a fibration.
\item if additionally $p$ or $f$ is a weak equivalence, then so so is $\langle f \, , p \rangle$.
\end{itemize}
 Indeed for any Horn inclusion $h^k_n: \Lambda^k[n] \rightarrow \Delta[n]$ the map $h^k_n \hattimes f$ is a trivial cofibration by the pushout-product property. Therefore,  it has the left lifting property against $p$, and hence $h^k_n$ has the left lifting property against $\langle f \, , p  \rangle$, which means that   $\langle f, p \rangle$ is a fibration. 





\section{Basic results on pullbacks}







\begin{proposition}\label{lem:cofibrant_fiber_product} \hfill 
\begin{enumerate}[$(i)$] 
\item Let $A \, , B$ be cofibrant simplicial sets. Then their product $A \times B$ is cofibrant.
\item Let $f \co A \to X$ and $g \co B \to X$ be maps with $A$ and $B$ cofibrant. Then their
fiber product $A \times_X B$, fitting in the pullback diagram
\[
\xymatrix{
A \times_X B \ar[r]^-{q} \ar[d]_-{p} & B \ar[d]^g \\
A \ar[r]_f & X \, ,}
\]
is cofibrant.
\end{enumerate}
\end{proposition}

\begin{proof} For part~(i), let $x = (a,b) \in (A \times B)_n$, if $A$ and $B$ are cofibrant one can apply the Eilenberg-Zilber lemma and write $a = p^*(a')$ and $b = q^*(b')$ with $a'$ and $b'$ non-degenerate cells and $p \co [n] \twoheadrightarrow [m]$ and $q \co [n] \twoheadrightarrow [k]$ are two degeneracies. We claim that $(a,b)$ is degenerate if and only if the map $(a ,b )  \co [n] \rightarrow [m] \times [k]$ is not monic, which is a decidable condition since $(a,b)$ is a map between finite decidable sets.

Indeed, the pair of map $(a,b)$ corresponding to a degenerate cell $x=r^*(x')$ for any non-trivial degeneracy $r \co [n] \twoheadrightarrow [n']$, is  $\big( p'(r),q'(r) \big)$ where $(p',q')$ are the maps corresponding to $x'$, and this is never monic as it factor into $r$, hence for a degenerate cell the condition above is always satisfied. Conversely, if $(p,q)\co [n] \rightarrow [m] \times [k]$ is not monic then as it is an increasing map there is some $i$ such that $p(i)=p(i+1)$ and $q(i)=q(i+1)$, hence $(p,q)$ can be factored into the $i$-th degeneracy map: $p=p' d_i$ and $q=q' d_i$ and in this case $x= d_i^* (p'^*(b'),q'^*(c'))$ is indeed a degenerate cell.


For part~(ii), $A \times_X B$ is a sub-simplicial set of $A \times B$ hence a cell of~$A \times_X B$ is degenerate if and only if it is degenerate as a cell of $A \times B$, hence degeneratness 
in~$A \times_X B$ is indeed decidable. 
\end{proof}






We use pullback functors to intepret substitution of terms into types. Given a map $f \co \Gamma' \to \Gamma$, we will show that the pullback functor $f^* \co \SSet_{/\Gamma} \to \SSet_{/\Gamma'}$ restricts to a functor
\[
f^* \co \BFFib_{/\Gamma}  \to \BFFib_{/\Gamma'} \, .
\]





\begin{proposition} \label{thm:cof-pbk}  Let $p \co A \to X$  be a map with cofibrant domain and codomain.
Then the pullback functor $p^* \co \SSet_{/X} \to \SSet_{/A}$ preserves cofibrations. 
\end{proposition}

\begin{proof} Let $f \co Y \to X$ be a cofibration and consider the pullback
\[
\xymatrix{
B \ar[r]^-{q} \ar@{>->}[d]_-{g} &  Y \ar@{>->}[d]^{f} \\
A \ar[r]_{p} & X}
\]
Since $A$ is cofibrant, the claim is that $g \co B \rightarrow A$ is a levelwise complemented monomorphism. For $a \in A_n$, we have that $a \in B_n$ if and only if $p(a) \in Y_n$. Since $f \co Y \rightarrow X$ is a levelwise complemented monomorphism, this is decidable.
\end{proof} 


\begin{remark} 
We conclude this section by observing that it is straightforward to define the interpretation of
$\Sigma$-types so that the computation rule and the $\eta$-rule hold as judgemental equalities. 
Let  $p \co A \to X$ be a fibration with cofibrant domain. The
functor~$\Sigma_p \co \SSet_{/A} \to \SSet_{/X}$ defined by
composition with $p$ restricts to a functor
$\Sigma_p \co \BFFib_{/A}  \to \BFFib_{/X}$
 Since fibrations are defined by a right lifting property, they are closed
under composition. Therefore, if $q \co B \to A$ is a fibration with cofibrant domain, then
$\Sigma_p(q) \co \Sigma_A(B) \to X$ is again a fibration with cofibrant domain.
\end{remark} 



\section{Path spaces}

The existence of the weak factorisation system $(\TrivCof, \Fib)$ 
implies that for every fibration with cofibrant domain $p \co A \to X$ the diagonal map $\delta_p \co A \to A \times_X A$ admits a factorisation as a trivial cofibration $i \co A \to P$ followed by a fibration $q \co P \to A \times_X A$. Here, we show that such a factorisation can be defined by taking a path object as the object $P$. 








\begin{lemma} \hfill 
 \label{thm:exponentials}
\begin{enumerate}[(i)] 
\item Let $X$ be cofibrant and $A$ be fibrant.  Then $A^X$ is fibrant.
\item Let $f \co Y \rightarrow X$ be a cofibration and $A$ be fibrant. Then $A^f \co A^X \rightarrow A^Y$ is a fibration.
\item Let $f \co Y \rightarrow X$ be a trivial cofibration and $A$ be fibrant.  Then $A^f \co A^X \rightarrow A^Y$ is a trivial fibration.
\item Let $X$ be cofibrant and $p \co B \rightarrow A$ be a (trivial) fibration. Then $p^X \co B^X \rightarrow A^X$ is also a trivial fibration.
\end{enumerate}
\end{lemma}

\begin{proof} The claims follow easily from the pushout product property of the model structure.
\end{proof}

Part~(i) of~\cref{thm:exponentials} can also be established directly, by inspecting the classical proofs, exploiting the decidability of degeneracy in $X$ instead of appealing to the law of excluded middle.






\medskip



\begin{proposition} \label{thm:id-types-for-types}
Assume that $A \in \SSet$ is fibrant. Then,
\begin{enumerate}[(i)] 
\item $A^{\Delta[1]}$ is fibrant,
\item the map $(s,t) \co A^{\Delta[1]} \rightarrow A \times A$ is a fibration.
\item the composite of $(s, t) \co A^{\Delta[1]} \rightarrow A \times A$ with either projection is a trivial fibration,
\item the map $r \co A \rightarrow A^{\Delta[1]}$ induced by $\Delta[1] \rightarrow \Delta[0]$ is a weak equivalence.
\end{enumerate}
\end{proposition} 

\begin{proof}
Part~(i) is just a special case of part~(i) of \cref{thm:exponentials}. For part~(ii), apply part~(ii) of \cref{thm:exponentials} to the cofibration $\partial \Delta[1]  \hookrightarrow \Delta[1]$. For part~(iii), apply part~(iii) of \cref{thm:exponentials} to the horn inclusions $\Lambda^k[1]  \rightarrow \Delta[1]$. Part~(iv) follows from the 3-for-2 property for weak equivalences applied to $A \rightarrow A^{\Delta[1]} \rightarrow A$. Indeed, the
composite is the identity and the second factor has just been proved to be a trivial fibration.
\end{proof}


In order to have a path object, we need $A^{\Delta[1]}$ to be cofibrant and the map $r \co A \rightarrow A^{\Delta[1]}$ to be a trivial cofibration. In a general setting, these properties are not to be expected
but in the special case of $\SSet$, this is achieved by the following proposition.

\begin{proposition}\label{proposition:PathObjectCofibrant}
Let $A$ be a cofibrant simplicial set. Then the simplicial set $A^{\Delta[1]}$ is cofibrant and the map~$r \co A \rightarrow A^{\Delta[1]}$ is a cofibration.
\end{proposition}



\begin{proof}
An $n$-cell of $A^{\Delta[1]}$ is the same as a morphism $\Delta[1] \times \Delta[n] \rightarrow A$. It is classical simplicial combinatorics that $\Delta[1] \times \Delta[n]$ is a simplicial set generated by $(n+1)$ distinct non-degenerate $(n+1)$-dimensional cell $\alpha_i: \Delta[n+1] \rightarrow \Delta[1] \times \Delta[n]$ for $0 \leqslant i \leqslant n$ which are defined as (the nerve of) the map $\alpha_i$ from $\{0,\dots,(n+1)\}$ to $\{0,1\} \times \{0,\dots,n\}$ such that $\alpha_i(k)=(0,k)$ if $k \leqslant i$ and $\alpha_i(k)=(1,k-1)$ if $k>i$. They satisfies only the relation $d_i^* \alpha_i = d_{i}^* \alpha_{i-1}$ for each $1 \leqslant i \leqslant n$.

So an $n$-cell $\sigma$ of $A^{\Delta[1]}$ is the same as collection of $n+1$-cells $\sigma(\alpha_i) \in A([n])$ for $i=0,\dots,n$ subject to the relations $d_i^* \sigma \alpha_i = d_{i}^* \sigma \alpha_{i-1}$ for $i=1,\dots,n$.


It can then be checked that:

\begin{itemize}

\item $\sigma$ is ``degenerate at $j$'', i.e. is of the form $s_j ^* \sigma'$ for $s_j : [n] \rightarrow [n-1]$ the map that repeat $j$ twice if and only if for each $i$, $\sigma \alpha_i $ is degenerate at $j+1$ for $i \leqslant j+1$ and at $j$ for $i \geqslant j$ (and at both if $i=j$ of $j+1$).

\item $\sigma$ is in the image of $A \rightarrow A^{\Delta[1]}$ if and only if $\sigma(\alpha_i)$ is degenerate at $i$ for all $i$.

\end{itemize}


For example, for the second condition, if $\sigma$ is the image of an $n$-cell $t \in A[n]$ then $\sigma \alpha_i = s_i^* x$ for all $i$, and conversely, if $\sigma \alpha_i$ are all of the form $s_i^* x_i$ then the relation $d_i^* \sigma \alpha_i = d_{i}^* \sigma \alpha_{i-1}$ implies that $x_{i-1}=x_i$ for all $i$ and hence $\sigma$ is indeed the image of the cell $x=x_0= \dots = x_n$. The proof of the first claim is very similar.

Now because $A$ is cofibrant for any given cell of $A$ one can decide whether it is degenerated or not, and by which degeneracy, so these the two question above are decidable as finite conjunction of decidable questions. As $\sigma$ is degenerated if and only if it is degenerated at $j$ for some $j$ this concludes the proof.
\end{proof}


\begin{remark}
We expect the cofibrancy of $A^{\Delta[1]}$ to extend to the case of $A^{X}$ when $X$ is any finite decidable simplicial set. But this is definitely not going to holds for infinite $X$ in general. For this reason, the definition of the interpretation of function types will involve a cofibrant replacement.
\end{remark} 


\bigskip


We now extend~\cref{thm:id-types-for-types} and~\cref{proposition:PathObjectCofibrant} 
to the case of a fibration $p \co A \rightarrow X$ with $A$ cofibrant  and $X$ bifibrant. We define $\Id_A$ 
via the pullback diagram
\[
\xymatrix{
\Id_A \ar[r] \ar[d] & A^{\Delta[1]} \ar[d] \\
X \ar[r] & X^{\Delta[1]} \\
}
\]
The structural maps $r \co A \rightarrow \Id_A$ and $(s, t) \co \Id_A \rightarrow A \times_{X} A$ are produced by the diagram:
\[
\xymatrix{
& A \ar[rr] \ar[dd] & & A^{\Delta[1]} \ar[rr] \ar[dd] & & A \times A \ar[dd] \\
A \ar[ur] \ar[rr] \ar[dd] & & \Id_A \ar[ur] \ar[rr] \ar[dd] & & A \times_{X} A \ar[ur] \ar[dd] \\
& X \ar[rr] & & X^{\Delta[1]} \ar[rr] & & X \times X \\
X \ar[ur] \ar[rr] & & X \ar[rr] \ar[ur] & & X \ar[ur] \\ 
}
\]
where the three square in the vertical/diagonal direction are pullbacks.


\begin{proposition}
\label{proposition:MainPathObject}
Assume $p \co A \rightarrow X $ is a fibration between bifibrant objects. Then,
\begin{enumerate}[(i)] 
\item \label{proposition:MainPathObject:IdBifib} $\Id_A$ is bifibrant, 
\item the map $\Id_A \rightarrow X$ is a fibration
\item the map $(s, t) \co \Id_A \rightarrow A \times_{X} A$ is a fibration,
\item the composite of $s \, , t \co \Id_A \rightarrow A \times_{X} A$  with either of the two projections is a trivial fibration,
\item the map $r \co A \rightarrow \Id_A$ is a trivial cofibration.
\end{enumerate}
\end{proposition}

\begin{proof}

The map $\Id_A \rightarrow X$ is a pullback of the maps $A^{\Delta[1]} \rightarrow X^{\Delta[1]}$ along $X \rightarrow X^{\Delta[1]}$. Hence as $A^{\Delta[1]} \rightarrow X^{\Delta[1]}$ is a fibration (by the last point of lemma \ref{thm:exponentials}), the map $\Id_A \rightarrow X$ is a fibration, in particular $\Id_A$ is fibrant. Since $X$ is cofibrant by assumption and $A^{\Delta[1]}$ is  cofibrant by \cref{proposition:PathObjectCofibrant}, we have that $\Id_A$ is also cofibrant by~\cref{lem:cofibrant_fiber_product}. 

Because of the dual of the pushout-product property, the map $\langle \partial \Delta[n] \hookrightarrow \Delta[n] ,  A \rightarrow X \rangle$ is a fibration. This map is 
\[ 
A^{\Delta[1]} \rightarrow (A \times A) \times_{X \times X} X^{\Delta[1]} 
\] 
Moreover, in the diagram
\[
\xymatrix{
\Id_A \ar[r] \ar[d] & A \times_{X} A \ar[d] \ar[r] & X \ar[d] \\
A^{\Delta[1]} \ar[r] & X^{\Delta[1]}  \times_{X \times X}  (A \times A) \ar[r]  & X^{\Delta[1]}
}
 \]
the right hand square is easily seen to be a pullback and the total rectangle is the pullback defining $\Id_A$, hence the left hand square is also a pullback. As we just showed that the bottom left map is a fibration, this implies that $\Id_A \rightarrow A \times_{X} A$ is a fibration as well.

A very similar argument gives that for $k=0 \, , 1$, the map $\langle \Lambda^k[n] \hookrightarrow \Delta[n] ,  A \rightarrow X\rangle$ is a trivial fibration. Indeed, this is the map
\[ 
A^{\Delta[1]} \rightarrow  A  \times_X X^{\Delta[1]} 
\] 
which fits into the pullback diagrams
\[
\xymatrix{
\Id_A \ar[r] \ar[d] & A  \ar[d] \ar[r] & X \ar[d] \\
A^{\Delta[1]} \ar[r] & A \times_X X^{\Delta[1]} \ar[r]  & X^{\Delta[1]}
}
 \]
which  shows that any of the two (dependings on whether $k=0$ or $k=1$) canonical maps $\Id_A \rightarrow A$ is a trivial fibration.

The map $A \rightarrow \Id_A$ is levelwise complemented. Indeed, it fits into a factorization 
\[
A \rightarrow \Id_A \rightarrow A^{\Delta[1]}
\] 
of a map which has been proved to be a levelwise complemented inclusion in~\cref{proposition:PathObjectCofibrant} and therefore for any cell of $\Id_A$ one can decide if it is in $A$ or not by considering it as a cell of $A^{\Delta[1]}$. Since $A$ and $\Id_A$ are cofibrant, this shows that $A \rightarrow \Id_A$ is a cofibration. The 3-for-2 property applied to $A \rightarrow \Id_A \rightarrow A$ show that  $A \rightarrow \Id_A$ is moreover a weak equivalence, hence a trivial cofibration.
\end{proof}


\section{The restricted Frobenius property}
\label{sec:Pi-types}



We wish to show that the weak factorisation system of fibrations and trivial cofibrations satisfies
a restricted version of the Frobenius property, asserting that pullback along fibrations with cofibrant
domains preserves trivial cofibrations. 
As is well known, by adjointness this implies that, for a fibration $p \co A \rightarrow X$ with cofibrant
domain, the dependent product functor $\Pi_p \co \SSet_{/A} \to \SSet_{/X}$ preserves fibrations. The proof of the restricted Frobenius property follows essentially~\cite{gambino2017frobenius}. In order to combine our development with that argument, however, we need the following preliminary proposition, in which we use the pushout product $\kcyl \hattimes f$ of an endpoint inclusion $\kcyl \co \braces{ k } \to \Delta[1]$ and a map~$f \co Y \to X$, which is defined as the unique dotted arrow  in the diagram:
\[
\xymatrix{
\braces{ k } \times Y \ar[r] \ar[d] &  \Delta[1]  \times X  \ar[d] \ar@/^1.5pc/[ddr] \\
\braces{ k} \times X \ar[r]  \ar@/_1.5pc/[drr] & \big( \Delta[1] \times Y ) \cup X \ar@{.>}[dr]  \\
 & &\Delta[1] \times  X \, .}
 \]



\begin{proposition} For a map $p \co B \to A$, the following conditions are equivalent.
\begin{enumerate}[(i)] 
\item The map $p$ is a fibration.
\item The map $p$ has the right lifting property with respect to the pushout products $ \kcyl  \hattimes f$, for every cofibration $i \co Y \to X$.
\item The map $p$ has the right lifting property with respect to the pushout products $ \kcyl  \hattimes h^n_k$, for every  
horn inclusion $h^n_k$. \noten{Need to fix indices to avoid clash of use of $k$}.
\end{enumerate}
\end{proposition} 

\begin{proof}The proof of \cite[Theorem~3.2.3]{joyal-tierney:simplicial-homotopy-theory} is completely constructive and sufficient to imply this result.
For more details, readers may also refer to the last claim in \cite[Corollary~5.3.2]{henry2018wms}
and \cite[Proposition~5.2.6]{henry2018wms}.
\end{proof}



Let $p \co A \rightarrow X$ be a fibration. By adjointness, $\Pi_p \co \SSet_{/A} \to \SSet_{/X}$  preserves fibrations if and only if the pullback functor $p^* \co \SSet_{/X} \to \SSet_{/A}$ preserves trivial cofibrations. Let us now assume that  $A$ is cofibrant. 
In this case $p^*$ preserves cofibrations by \cref{thm:cof-pbk}, so we only need to show that it preserves
trivial cofibrations. We achieve this by following closely \cite[Section~3]{gambino2017frobenius}. Note that we cannot apply directly the result therein since 
the assumption that every object is cofibrant does not hold in our setting. However, only minor modifications are sufficient.


% \begin{lemma} \label{thm:missing-1}
% \hfill 
% \begin{enumerate}[(i)] 
% \item $\mathcal{J} \subset \Cof \cap \mathcal{S}$.
% \item $\Cof \cap \mathcal{S} \subseteq \TrivCof$.
% \end{enumerate}
% \end{lemma} 


\begin{definition} \label{def:strhtpyequiv} Let $k \in \braces{0 \, , 1 }$.
A map $f \co Y \rightarrow X$ in $\SSet$ is a \myemph{strong $k$-oriented homotopy equivalence} if there are maps $H$ and $H_X$ which exhibit $f$ as a retract of $\delta^k \times ' f$ as follows:

\[
\xymatrix@C=2cm{
Y \ar[d]_{f} \ar[r]^-{\delta^{1-k} \times Y} & 
( \Delta[1] \times Y ) \cup X \ar[d]^{\delta^k \times' f} \ar[r]^-{H_X} & 
Y \ar[d]^{f} \\
X \ar[r]_-{\delta^{1-k} \times X}  & 
\Delta[1] \times X \ar[r]_{H} &
X  }
\]
\end{definition}

This definition is equivalent to the one given in \cite{gambino2017frobenius} by Lemma~3.3 therein.
With this definition, it is immediate to observe that a cofibration which is a strong $k$-oriented homotopy equivalence is a trivial cofibration. Indeed, if $f \co Y \to X$ is a cofibration then $\delta^k \times ' f$ is 
a weak equivalence by the pushout-product property and so $f$ is also a weak equivalence, since it is a retract of $\delta^k \times ' f$.

\begin{lemma}\label{lemma:genTcof_strongHequiv} \hfill 
\begin{enumerate}[$(i)$]
\item For $i < n$, the horn inclusions $h^n_i \co \Lambda^i[n] \rightarrow \Delta[n]$ are strong $0$-oriented homotopy equivalences,
\item For $0 < i $, the horn inclusions $h^n_i \co \Lambda^i[n] \rightarrow \Delta[n]$ are strong $1$-oriented homotopy equivalences.
\end{enumerate}
\end{lemma}

\begin{proof}
This is shown as part of~\cite[Theorem 3.2.3]{joyal-tierney:simplicial-homotopy-theory}. The proof given there can be easily checked to be constructive. This argument as also been reproduced (in the context of complicial sets) in the first part of the proof of \cite[Proposition~5.2.6]{henry2018wms} which is developed in constructive settings.
\end{proof}

%I've only added the reference to my paper to avoid having Joyal and Tierney's notes as unique reference for this. But If you think it is fine, you can remove it.



\begin{lemma} 
\label{lemma:pb_of_StrongHomotopyEq}
Let $p \co A \rightarrow X$ be a fibration with cofibrant domain. Then, for $k \in \{0,1\}$, 
the pullback functor $p^* \co \SSet_{/X} \to \SSet_{/A}$ preserves strong $k$-oriented homotopy equivalences.
\end{lemma}



\begin{proof} This is essentially \cite[Lemma~3.7]{gambino2017frobenius}, but we provide some details
for the convenience of the reader.
Let $f \co Y \rightarrow X$ be a strong $k$-oriented homotopy equivalence. Let $H$ and $H_X$  maps 
as in~\cref{def:strhtpyequiv}. Let $p \co A \rightarrow X$ be a fibration with cofibrant domain and consider the pullback
\[
\xymatrix@C=1.5cm{
A[f] \ar[r]^-{p^*(f)}  \ar[d]_{p_{A[f]}} & A \ar[d]^{p} \\
Y \ar[r]_{f} & X \, .\\
}
\] 
To show that $p^*(f)$ is a strong $k$-oriented homotopy equivalence, we let $K \co \Delta[1] \times A \rightarrow A$ be a diagonal filler in the square:
\[
\xymatrix@C=1.5cm{
A \ar[d]_{\delta^{1-k}} \ar@{=}[rr] & & A \ar[d]^p \\ 
\Delta[1] \times A \ar[r]_{\Delta[1] \times p}  & \Delta[1] \times X \ar[r]_H & X
}\]
Where the map on the left-hand side is anodyne because $A$ is a cofibrant.
It remains to construct a map $K_Y$  fitting into a retract diagram of the form
\[
\xymatrix@C=1.5cm{
A[f]  \ar[d]_{p^*(f)} \ar[r] &  (\Delta[1] \times A[f])  \cup Y \ar[d]^{\delta^k \times' p^*(f)} \ar[r]^-{K_Y} & A[f] \ar[d]^{p^*(f)} \\
A \ar[r] & \Delta[1]  \times A \ar[r]_-{K} & A
}
\]
We define it using the universal property of $A[f]$ as the unique map to $A[f]$ such that the image in $X$ is the one specified by the diagram above, and the value in $Y$ is the one given by $H_X$ composed with the map $(\Delta[1] \times A[f]) \cup Y$ to $(\Delta[1] \times A[f]) \cup X$. These indeed have the same image in $X$ exactly because of the commutation of lower triangle in the filler diagram defining~$H'$. The commutation of the diagram and the fact that the upper line is a retract are immediate with this definition.
\end{proof}



\begin{proposition}\label{prop:Frobenius}
Let $p \co A \rightarrow X$ is a fibration with cofibrant domain. Then the pullback functor 
\[
p^* : \SSet_{/X} \rightarrow \SSet_{/A}
\] 
preserves cofibrations and anodyne morphisms.
\end{proposition}


\begin{proof} Since the pullback functor $p^*$ has a right adjoint,  it is enough to check that pullbacks of generating cofibrations and generating anodyne are cofibrations and anodyne, respectively. For cofibrations, this is \cref{thm:cof-pbk}. For anodyne, the anodyne morphisms in $\SSet_{/Y}$ are generated by the horn inclusions $h^k_n \co \Lambda^{k}[n] \rightarrow \Delta[n]$ for all possible choices of $\Delta[n] \rightarrow A$. By \cref{lemma:genTcof_strongHequiv} they are all strong $k$-oriented homotopy equivalences. Moreover, their pullback to $X$ is also their pullback along the map $A \times_X \Delta[n] \rightarrow \Delta[n]$ which is again a fibration with cofibrant domain by \cref{lem:cofibrant_fiber_product}. Hence  \cref{lemma:pb_of_StrongHomotopyEq} implies that the pullback 
to~$X$ are also strong $k$-oriented homotopy equivalences. Since they are cofibrations, they are anodyne by the remark just below \cref{def:strhtpyequiv}.
\end{proof}



\begin{corollary}\label{cor:Pi_types_are_fibrant}
Let $p \co A \rightarrow X$ be a fibration with cofibrant domain. The functor $\Pi_p \co \SSet_{/A} \to \SSet_{/X}$ restricts to a functor
\[
\Pi_p \co \Fib_{/A}  \to \Fib_{/X} \, .
\]
Furthermore, this restriction preserves  trivial fibrations.

\end{corollary}

\begin{proof}
Since $p^*$ preserves cofibrations and trivial cofibrations, its right adjoint $p_*$ preserves trivial fibrations and fibrations. In particular, it preserves fibrant objects.
\end{proof}


Given a cofibrant simplicial set $X$ and a fibrant simplicial set, the special case of \cref{cor:Pi_types_are_fibrant} with $p$   the unique map $A \to 1$ and $q$ the second projection 
$\pi_2 \co A \times A \to A$, which is a fibration if~$A$ is a  fibrant, implies that $A^X$ is fibrant, as we already established in part~(i) 
of~\cref{thm:exponentials}. 




% \begin{theorem} 
% \label{thm:restricted-frobenius}
% The semi-model structure for Kan complexes on $\SSet$ has the restricted Frobenius condition.
% \end{theorem} 

% \begin{proof}  Since the semi-model structure in which we 
% are working is cofibrantly generated, it is sufficient [TO CHECK] that $p^*$ sends generating trivial cofibrations to trivial cofibrations. So, let $p \co B \to \Delta[n]$ be a fibration, $i \co \Lambda^k[n]
% \to \Delta[n]$ be a horn inclusion, and define $ j \defeq p^*(i)$, given by 
% the pullback diagram
% \[
% \xymatrix{
% \bullet  \ar[r] \ar[d]_j \drpullback & \Lambda^k[n] \ar[d]^{i} \\
% B \ar[r]_-{p} & \Delta[n] }
% \]
% We need to show that $j$ is a trivial cofibration.  
% First, since $i$ is a trivial cofibration, it is in particular
% a cofibration and therefore $j$ is again a cofibration by~\cref{thm:cof-pbk}. Secondly, since~$i \in \cal{J}$,
% by part~(i) of \cref{thm:missing-1}, it is a cofibration and a strong homotopy equivalence. Since its codomain is cofibrant, $j$ is a strong homotopy equivalence by~\cref{thm:missing-2}.
% But now $j$ is both a cofibration and a strong homotopy equivalence
% and hence it is a trivial cofibration, as required, by part~(ii) of \cref{thm:missing-2}.
% \end{proof} 



 


\begin{remark}[$\Pi$-types] \label{rem:pi-types}
We shall interpret $\Pi$-types via a cofibrant replacement of dependent product. In order to explain this, let
us recall that, for maps $p \co A \to X$ and $q \co B \to A$,  the dependent product $\Pi_p(q) \co \Pi_A(B)
\to X$ is equipped with a map
\[
\mathsf{app} \co \Pi_A(B) \times_A  A \to B
\] 
in $\SSet_{/A}$ which is universal in the sense that, for every  $Y \to X$, the function
\[
\begin{array}{rcl} 
 \SSet_{/X}[ Y , \Pi_A(B)] & \longrightarrow &  \SSet_{/A}[Y \times_A A, B]  \\
  f & \longmapsto & \mathsf{app}(f \times_A 1_A) 
  \end{array} 
 \]
 is a bijection. This means that we have a function $\lambda$ in the opposite direction such that  
 \begin{equation}
 \label{equ:betaeta}
 \mathsf{app}(\lambda(b) \times_A 1_A) = b   \, , \quad
 \lambda( \mathsf{app}(f \times_A 1_A)) = f \, ,
 \end{equation}
 for every $b \co Y \times_A A \to B$ and $f \co Y \to \Pi_A(B)$.  These equations correspond to the
 well-known $\beta$-rule and $\eta$-rule for $\Pi$-types, respectively.
 
 When $p$ and $q$ are fibrations and $A$ is cofibrant, the map 
 $\Pi_p(q) \co \Pi_A(B) \to X$ is a fibration by \cref{cor:Pi_types_are_fibrant} but $\Pi_A(B)$ is not cofibrant
 in general. Thus, we interpret  $\Pi$-types as the 
 cofibrant replacement  of $\Pi_A(B)$, which is given by a cofibrant simplicial set
 $\mathbb{L}(\Pi_A(B)$  equipped with
 a trivial fibration $t \co \mathbb{L}(\Pi_A(B)) \to \Pi_A(B)$. 
We then define $\widetilde{\mathsf{app}} \co   \mathbb{L}(\Pi_A(B)) \times_A A \to B$ by letting
\[
\widetilde{\mathsf{app}}  = \mathsf{app} \circ (t \times_A 1_A) \, .
\]
For a bifibrant simplicial set $Y$ and maps $Y \to X$,  $b \co Y \times_A A \to B$, we define $\widetilde{\lambda}(b) \co Y \to \mathbb{L}(B^A)$ to be the
diagonal filler
\[
\xymatrix{
0 \ar[r] \ar[d] & \mathbb{L}(\Pi_A(B))  \ar[d]^t \\
Y \ar[r]_{\lambda(b)} \ar@{.>}[ur] & \Pi_A(B)}
\]
which exists since $Y$ is cofibrant and $t$ is a trivial fibration. It follows immediately that
\[
 \widetilde{\mathsf{app}}(\widetilde{\lambda}(b) \times_A 1_A) = b \, ,
\]
so the $\beta$-rule holds as an equality. Instead, for $f \co X \to \mathbb{L}(\Pi_A(B))$, we have a homotopy
\[
\eta_f  \co \widetilde{\lambda}( \widetilde{\mathsf{app}}(f \times_A 1_A)) \sim  f  \, ,
\]
which is constructed as the diagonal filler in the following diagram
\[
\xymatrix@C=2cm{
\partial \Delta[1] \times Y \ar[r]^-{[f, \widetilde{\lambda}(f \times 1_A)]} \ar[d] & \mathbb{L}(\Pi_A(B)) \ar[d]^t \\
\Delta[1] \times Y \ar[r] \ar@{.>}[ur] & \Pi_A(B) }
\]
where the bottom map is given by the equality in the $\eta$-rule in~\eqref{equ:betaeta}.
\end{remark}



\section{The weak equivalence extension property}
\label{sec:equep}

The main goal of this section is to prove the so-called weak equivalence extension property, which will be the key to prove the existence and univalence of a weakly universal fibration.  For this, we follow closely the approach in \cite{voevodsky-simplicial-model}, but exploiting crucially the cofibrancy requirements that are part of our set-up.



\begin{lemma}\label{Lemma:ForTheExtProperty} Let $f \co Y \rightarrow X$ be a cofibration with $Y$ cofibrant. 
\begin{enumerate}[$(i)$]
\item The functor $\Pi_f \co \SSet_{/Y} \rightarrow \SSet_{/X}$ preserves trivial fibrations.
\item The counit of the adjunction $f^* \dashv \Pi_f$ is a natural isomorphism.
\item If $g \co Z \to Y$  is cofibrant in $\SSet_{/Y}$, then $\Pi_f(g) \co \Pi_f(Z) \to X$  is cofibrant in~$\SSet_{/X}$.
\item Trivial fibrations extend along cofibrations with cofibrant domain, \ie given a trivial fibration $q
 \co B \to Y$  as in the solid diagram:
\[
\xymatrix{
B \ar@{.>}[r]^{g} \ar[d]_{q} \drpullback  & A \ar@{.>}[d]^{p} \\
Y \ar[r]_f &  X \, ,}
\]
then there exists a trivial fibration $p \co A \rightarrow X$ which fits in the dotted pullback square above. Moreover if $B$ is cofibrant  then 
$A$ can be chosen to be 
cofibrant as well.
\end{enumerate}
\end{lemma}

 
\begin{proof} We prove the different parts separately. 
\begin{enumerate}[$(i)$] 
\item 

Since the functor $\Pi_f$ is the right adjoint to the pullback functor $f^*$ and trivial fibrations are the maps with the the right lifting property with respect to cofibrations, $\Pi_f$ preserves trivial fibrations if and only if $f^*$ preserve cofibrations. But this follows by~\cref{thm:cof-pbk}.

\item As $f$ is a monomorphism, then the forgetful functor $\Sigma_{f} \co \SSet_{/X} \rightarrow \SSet_{/Y}$ is fully faithful and hence the unit $\eta \co 1_{\SSet_{/A}} \rightarrow f^* \Sigma_{f}$ is an isomorphism. By adjointness, the counit $\varepsilon \co f^* \Pi_f \rightarrow 1_{\SSet_{/Y}}$ is also an isomorphism.

\item \hfill 

\begin{center}
\noten{To be revised} 
\end{center}

Let $v$ be a $n$-cell in $\Pi_i(X)$.
If the image of $v$ is in $A$ then $v$ is a cell of $X \subset \Pi_i(X)$, in which case it is decidable whether $v$ is degenerate or not.
As $A$ is levelwise complemented in $B$, one can assume that $v$ is not in the image of $A$. In this case it is decidable if the image of $v$ in $B$ is degenerate or not.
Infact, by the Eilenberg-Zilber lemma one can also decide for each given degeneracy if the image of $v$ is degenerate for this precise degeneracy or not. 

Let $\sigma \co [n] \twoheadrightarrow [k]$ be any degeneracy, we will show that it is decidable whether $v$ is ``$\sigma$-degenerate, i.e. if $v =\sigma^* v'$ for some $v'$. Note that if $v$ is $\sigma$-degenerate then its image in $B$ is as well. As this is a decidable question, one can freely assume that the image of $v$ in $B$ is $\sigma$-degenerate, i.e. for the form $\sigma^* b$ for some $b \in B$ (and not in $A$).

 One can form the pullback square:


\[
\xymatrix{
V \ar@{^{(}->}[r] \drpullback \ar[d] & \Delta[n] \ar@{->}[d]^{\sigma} \\
V_{\sigma} \ar@{^{(}->}[r] \drpullback \ar[d] & \Delta[k] \ar@{->}[d]^b \\
A \ar@{^{(}->}[r] &  B }
\]

Given its image in $B$, the cell $v: \Delta[n] \rightarrow \Pi_i X$ is uniquely determined by the data of a morphism $\lambda: V\rightarrow X$. The cell $v$ is $\sigma$-degenerate if and only if $\lambda$ factors in $V_{\sigma}$ (such a factorization being unique if it exists). For any $J \subset [n]$, the $J$-face of a cell is said to be $\sigma$-degenerate if and only if it is degenerate for the (potentially trivial) degeneracy: $\sigma_{|J} : J \rightarrow \sigma(J)$. We claim that $\lambda$ factor into $V_{\sigma}$ if and only for all $i:[f] \hookrightarrow [n]$ that belong to $V$ (and $V$ is decidable so there is only a finite cardinal of them), $i^* \lambda$ is $\sigma$-degenerate (which is dediable). Indeed $V$ is the gluing of all the $\sigma \circ i$ for such faces, for each individual face $i$ one has a factorization into its image in $V_{\sigma}$ if and only if $i^* \lambda$ is $\sigma$-degenerate, and as such factorization are unique they patch together on $V_{\sigma}$ is they all exists.

\item One can simply take $p \co A \to X$ to be $\Pi_f(q) \co \Pi_f(B) \to X$. Indeed, it is a trivial fibration by part~$(i)$ and the square is a pullback by part $(ii)$. The final remark about the cofibrancy of 
$A$ follows from $(iii)$. \qedhere
\end{enumerate}
\end{proof}


\notesh{I remember we proved $(iii)$ explicitly as this was something I was worried about. But the proof above is a lot harder than in my memories. Do you have any notes about this claims ? If not just erase this note.}



\begin{proposition}[Weak equivalence extension property]
\label{Prop:Homotopy_ext_prop}
Let 
\[
\xymatrix{
B \ar[r]^g \ar[d]_q & A \ar[d]^p \\
Y \ar[r]_f & X}
\]
be a commutative diagram with $p \co A \to X$ and $q \co B \to Y$ be fibrations, $f \co Y \to X$ 
a cofibration and such that the map $u \co B \to A[f]$ defined by $u \defeq (q, g)$, fitting the diagram 
of solid maps
\[ 
\xymatrix{
 B
  \ar@{.>}[rr]
  \ar[dr]^{u}
  \ar[dd]_(.3){q}
&&
  \bar{B}
  \ar@{.>}[dr]^{v}
  \ar@{.>}[dd]_(.3){\bar{q}}|{\hole}
&\\&
  A[f] 
  \ar[rr]
  \ar[dl]
&&
  A
  \ar[dl]^{p}
\\
  Y
  \ar[rr]_{f}
&&
  X \, ,
&
}
\]
is a weak equivalence in $\SSet_{/ Y}$. Then there exist a fibration $\bar{q} \co \bar{B} \to X$, a weak equivalence $v \co \bar{B} \to A$ in $\SSet_{/X}$ and a map $B \to \bar{B}$ such that all the squares in the diagram above are pullbacks. 
\end{proposition}

\begin{proof} We define the required object $\bar{B}$ as the following pullback:
\[\xymatrix{
\bar{B} \ar[d] \ar[r] \drpullback & \Pi_Y(B) \ar[d] \\
A \ar[r]_-{\eta_{A}} & \Pi_Y \big( A[f]  \big) \, ,
}\]
where $\eta_{A}$ is  a component of the unit of adjunction  $f^* \dashv \Pi_f$. An application of the pullback functor $f^* \co \SSet_{/X} \to \SSet_{/Y}$ to this pullback square gives the commutative square
\[\xymatrix{
\bar{B}[f] \ar[d] \ar[r]  & B \ar[d] \\
A[f] \ar@{=}[r] &A[f] 
}\]
This is a pullback since $f^* \Pi_f \iso 1$ by part~(ii) \cref{Lemma:ForTheExtProperty}. Hence 
$B \iso \bar{B}[f]$, as required.


Since $B$ is cofibrant, we have that $\Pi_Y(B)$ is cofibrant by part~(iii) of  \cref{Lemma:ForTheExtProperty}. Hence, the simplicial set~$\bar{B}$  is also cofibrant by \cref{lem:cofibrant_fiber_product}. Furthermore, the maps $B \rightarrow \bar{B}$ and~$A[f] \rightarrow A$ are cofibrations by~\cref{thm:cof-pbk}, as they are pullback of the cofibration~$f \co Y \rightarrow X$.





It remains to prove that $v \co \bar{B} \rightarrow A$ is a weak equivalence and that 
$\bar{q} \co \bar{B} \rightarrow X$ is a fibration. Since the map $u$ can be factored into a trivial cofibration followed by a trivial fibration, and our construction are functorial, it is sufficient to prove these claims when~$u$ is a trivial fibration or a trivial cofibration.

If $u$ is a trivial fibration, then its image under $f_*$ is a trivial fibration by 
part~(i) of \cref{Lemma:ForTheExtProperty}. Since the map $\bar{B} \rightarrow A$ is a pullback of this map,
it is also a trivial fibration. This also implies that the composite $\bar{B} \rightarrow A \rightarrow X$ is a fibration.


We now assume that $u \co B \rightarrow A[f]$ is a trivial cofibration. Using that the maps from $\bar{B}$ and $A[f]$ to $Y$ are fibrations between fibrant objects, we can show that $u$ is a strong deformation retract over $Y$, \ie there is a retraction $r \co A[f] \rightarrow B$ of $u$ in $\SSet_{/Y}$ and a homotopy 
\[
H \co \Delta[1] \times A[f] \rightarrow A[f]
\] 
between 
$u \circ r$ and $1_{A[f]}$, whose composite with $A[f] \rightarrow Y$ is the trivial homotopy.

We want to show that $\bar{B} \rightarrow A$ is also a deformation retract by constructing a similar homotopy 
\[
H' \co \Delta[1] \times A \rightarrow A \, .
\] 
This homotopy will be constructed so that it is $H$ on $I \times A[f]$ ,  it is the map 
\[
\Delta[1] \times \bar{B} \rightarrow \Delta[0]  \times \bar{B} \iso \bar{B} \rightarrow A
\] 
on $\Delta[0] \times \bar{B} $ (indeed they agree on $\Delta[1] \times B$) and it is the identity on $\Delta[0] \times A$.  This is achieved by taking a diagonal filling in the square:
\[
\xymatrix@C=1.5cm{
\big( \Delta[1] \times (\bar{B} \cup A[f]) \big)  \cup \big( \Delta[0] \times A \big) \ar[d] \ar[r] & A \ar[d] \\
\Delta[1] \times A \ar[r] \ar@{.>}[ur]^{H'} & X
}\]
Such a diagonall filler exists since the map on the left-hand side is a trivial cofibration, being the 
 pushout-product of $Y_0 \co \Delta[0] \rightarrow \Delta[1]$ and the cofibration $\bar{B} \cup A[f] \rightarrow A$, and the map on the right-hand side is a fibration by assumption.

It remains to see that the map $H_{1} \co A \rightarrow A$ is indeed a retraction of $\bar{B} \rightarrow A$. We already know that the restriction of $H_{1}$ to $\bar{B}$ is  the inclusion of $\bar{B}$ in $A$, so it is enough to show that $H_{1}$ has values in $\bar{B}$. We also know that $H_{1}$ restricted to $A[f]$ takes values in $B \subseteq \bar{B}$. By definition of $\bar{B}$, the map $H_1$ factor into $\bar{B}$ if and only if it takes values in $\Pi_Y(B)$ when seen as a map to $\Pi_Y(A[f])$, and by adjunction this is the case if and only if the map corresponding to $H_1$, $A[f]= f^*(A) \rightarrow A[f]$ takes values in $B$, but already mentioned above that this was indeed the case.

The fact that $\bar{B} \rightarrow A$ is a deformation retract show that it is invertible in the homotopy category, in particular it is indeed a weak equivalence. The construction above also shows that~$\bar{B}$ is retract of $A$ in $\SSet_{/X}$ and hence $\bar{q} \co \bar{B} \rightarrow X$ is a fibration because $p \co A \rightarrow X$ is.
\end{proof}

 

\section{A univalent  fibration with bifibrant base}







Our next goal is to define a bifibrant simplicial set $\U_c$ and a small fibration $\pi_c \co \UU_c \to \U_c$ that weakly classifies small fibrations between cofibrant objects, in the sense that for every such fibration $p \co A \to X$ there exists a map $a \co X \to \U_c$ such that $p$ fits in a pullback diagram of the form
\[
\xymatrix{
A \ar[r] \ar[d]_p   & \UU_c \ar[d]^{\pi_c} \\
X \ar[r]_a &  \U_c }
\]
In order to do this, we proceed in two steps. First, we modify  the construction of the weak classifier for small fibrations in~\cite{voevodsky-simplicial-model} to obtain a small fibration $\pi \co \UU \to \U$ which weakly classifies  small fibrations between cofibrant objects. We then consider a suitable cofibrant replacement 
of~$\U$ and obtain the required fibration $\pi_c \co \UU_c \to \U_c$ via a 
pullback. 

\medskip

As a preliminary step, let us recall that a simplicial set $A$ is \emph{small}  if $A_n$ is a small set for every $[n] \in \Delta$ and that a map $p \co A \to X$ of simplicial sets is \emph{small} if for every $x \co \Delta[n] 
\to X$ the simplicial set~$A[x]$ given by the pullback square
\[
\xymatrix{
A[x] \ar[r] \ar[d] \drpullback & A \ar[d]^{p} \\
\Delta[n] \ar[r]_-{x} & X }
\]
is small. Let us also recall the  construction of the weakly universal small map of simplicial sets $\rho \co \VV \to \V$, which is a special case of the results in~\cite{hofmann-streicher-universes} for arbitrary presheaf categories.  For this, we use the equivalence in~\eqref{equ:pshslice} and the notation associated to it, as introduced
in~\cref{sec:preliminaries}. 
The simplicial set $\V$ is defined by letting
\[
\mathsf{V}_n \defeq \{ F \in \Psh(\Delta_{/[n]}) \ | \ \pi_1 \co \mathsf{el}(F) \to \Delta[n] \text{ is a small
map} \}
\]
for $[n] \in \Delta$. The map $\rho \co \VV \to \V$ is then defined in an evident way. 


\bigskip

We now come to our first step, in which we define a small fibration $\pi \co \UU \to \U$ which weakly classifies  small fibrations between cofibrant objects. For this, we define $\U$ as a subobject $\U \rightarrowtail \V$ by letting, for $[n] \in \Delta$, 
\[
\U_n = \{ F \in \V_n \ | \ \pi_1 \co \mathsf{el}(F) \to \Delta[n] \text{ is a small Kan fibration and $\mathsf{el}(F)$ is cofibrant} \} \, .
\]
We then define the map $\pi \co \UU \to \U$ via the pullback 
\[
\xymatrix{
\UU \ar[r] \ar[d]_\pi \drpullback  & \VV \ar[d]^\rho \\
\U \ar@{>->}[r] & \V }
\]




\begin{proposition} \label{thm:universe-u}  \hfill 
\begin{enumerate}[(i)] 
\item The map $\pi \co \UU \to \U$ is a small fibration.
\item For any map $a \co X \rightarrow \U$ with $X$ cofibrant, the 
simplicial set $A$ given by the pullback
\[
\xymatrix{
A \ar[r] \ar[d]_p & \UU \ar[d]^\pi \\
X \ar[r]_a & \U }
\]
is cofibrant.
\item The map $\pi \co \UU \to \U$ weakly classifies small fibrations between cofibrant objects, \ie 
for every small fibration $p \co A \to X$ between cofibrant objects there exists a map 
$a \co X \to \U$ and a pullback  of the form
\[
\xymatrix{
A \ar[r] \ar[d]_p \drpullback & \UU \ar[d]^\pi \\
X \ar[r]_{a} & \U }
\]
\end{enumerate}
\end{proposition}

\begin{proof} We prove the three claims separately.
\begin{enumerate}[(i)] 
\item For any map $a \co \Delta[n] \rightarrow \U$, we can consider the following pullbacks
\[
\xymatrix{
A \ar[r] \ar[d]_p  & \UU \ar[d] \ar[r]  & \VV \ar[d] \\
\Delta[n] \ar[r]_{a} & \U \ar[r]_{i} & \V }
\]
This shows that $p \co A \rightarrow \Delta[n]$ is isomorphic to $\pi_1 \co \mathrm{el}(F) \rightarrow \Delta[n]$ in $\SSet_{/ \Delta[n]}$, where $F$ corresponds under the equivalence in~\eqref{equ:pshslice} to 
$i a \co \Delta[n] \rightarrow \V$. Therefore, by definition of $\U$, $A$ is cofibrant and $p \co A \rightarrow \Delta[n]$ is a small fibration. This implies that $\pi \co \UU \rightarrow \U$ is a small map. Furthermore, $\pi$ is a fibration
since we can rewrite a general lifting problem against a horn inclusion $h^n_k \co \Lambda^k[n] \rightarrow \Delta[n]$ as follows:
\[
\xymatrix{
\Lambda^k[n] \ar[r] \ar[d]_{h^k_n} & A  \ar[d]^{p} \ar[r] & \UU \ar[d]^\pi \\
\Delta[n] \ar@{=}[r]  & \Delta[n] \ar[r]_a & \U  }
\]
and then use that $p \co A  \to \Delta[n]$ is a fibration.
\item  Let $[n] \in \Delta$, $a \in A_n$ and define $x \defeq p(a)$. Since $X$ is cofibrant, by the Eilenberg-Zilber lemma we can write it in a unique way as $x=s^*(x')$, where $s \co [n] \twoheadrightarrow [k]$ is a degeneracy and 
$x' \in X_k$ is a non-degenerate cell. Let $x' \co \Delta[k] \rightarrow X$ be the corresponding map. We now form the pullback
\[
\xymatrix{
E \ar[r]^w \ar[d] \drpullback & A \ar[r] \ar[d]_{p} \drpullback & \UU \ar[d]^\pi \\
\Delta[k] \ar[r]_{x'} & X \ar[r] & \U }
\]
By the universal property of the pullback, there is a unique cell $e \in E_n$ such that $w(e)=a$, and the image of $e$ in $\Delta[k]$ is the cell $s \co [n] \twoheadrightarrow [k]$, whose image in $X$ are both equal to $x=s^* x'$.

By definition of $\U$, the simplicial set $E$ is cofibrant and hence it is decidable whether $e$ is degenerate or not. We claim that $a$ is degenerate if and only if $e$ is, which implies that it is decidable whether $a$ is degenerate.

Indeed as $a = w(e)$ then if $e$ is degenerate so $a$ is. Conversely, assume that $a=p^*(y_1)$ for a non-trivial degeneracy $p$. Then $x=p^*(x_1)$, hence by the uniqueness part of the Eilenberg-Zilber lemma for $X$ one has that $s=q \circ p$ for some degeneracy $q$, and $x_1 = q^*(x')$. In particular, we get a unique cell $e_1$ of $E$ whose image in $\Delta[n]$ and $Y$ are  $q$ and $a_1$, respectively, whose images in $X$ are both equal to $x_1=q^*(x')$. Finally, the image of $p^*(e_1)$ in $\Delta[n]$ and~$A$ are  $p^* y_1 =a$ and $q \circ p =s$, respectively, and hence $p^*(e_1) =e$, which proves that $e$ is degenerate as soon as $a$ is.



\item Any small map $p \co A \rightarrow X$ is a pullback of $\rho \co \VV \rightarrow \V$. The corresponding map $a \co X \rightarrow \V$ factors in $\U \subseteq \V$ if and only if for every $x \co \Delta[n] \rightarrow X$ the pullback $x^*(A) \rightarrow \Delta[n]$   is a small fibration with $x^*(A)$ cofibrant. So if $A$ is cofibrant then the simplicial set $x^*(A)$ is cofibrant because of~\cref{lem:cofibrant_fiber_product}. Finally, if $p \co A \rightarrow X$ is a small fibration then any of its pullback is also a small fibration.  \qedhere
\end{enumerate}
\end{proof} 





We now prove that the fibration $\pi \co \UU \to \U$ is univalent in the sense of~\cite{voevodsky-simplicial-model}.
Let $\U^{\rightarrow}$ be the simplicial set whose $n$-simplices are triples of the form $(F_0, F_1, \phi)$, where $F_0$ and $F_1$ are $n$-simplices of $\U$, \ie functors
 \[
F_0, F_1 \co {\Delta_{/[n]}}^{\op} \rightarrow \Set
\]
and $\phi \co F_0 \Rightarrow F_1$ is a natural transformation. By the equivalence in~\eqref{equ:pshslice},
such triples correspond to commutative diagrams of the form
\begin{equation}
\label{equ:corresp}
\begin{gathered}
\xymatrix{ 
A_1 \ar[rr]^{f} \ar[dr]_{p_1} & & A_2 \ar[dl]^{p_2} \\
& \Delta[n] & }
\end{gathered}
\end{equation}
where $p_1$ and $p_2$ are fibrations with cofibrant domain.
We define $\mathsf{Weq}(\U)$ as the simplicial subset of $\U^\to$ whose $n$-simplices are the $n$-simplices $(F_1, F_2, \phi)$ of $\U^\to$ such that the corresponding map~$f$ in~\eqref{equ:corresp} is a weak equivalence.
The simplicial set $\mathsf{Weq}(\U)$ is well defined because pullback functors are right Quillen functors \cite[???]{henry2019qms} and therefore preserve weak equivalences. Hence, 
$\mathsf{Weq}(\U)$ as defined here is indeed a subobject of $\U^{\rightarrow}$. \caution{To be checked again!}

\begin{lemma}
\label{prop:Weq_classify_Weq}
For any cofibrant object $X$, a map $a \co X \rightarrow \U^{\rightarrow}$ factors via 
 $\mathsf{Weq}(\U)$ if and only the map in $\BFFib_{/X}$ classified by $a$,
\[
\xymatrix{
A_1 \ar[rr]^w  \ar[dr]_{p_1} & & A_2 \ar[dl]^{p_2} \\
 & X \, , & }
 \]
is a weak equivalence.
\end{lemma}

\begin{proof} By definition of $\mathsf{Weq}(\U)$, $a$ factors via $\mathsf{Weq}(\U)$ if and only if the pullback of $w \co A_1 \to A_2$ along any simplex $x \co \Delta[n] \rightarrow X$  is a weak equivalence. \caution{As observed above, this is indeed the case if $w$ is a weak equivalence.} Conversely,
we let $w \co A_1 \rightarrow A_2$ be a map between bifibrant objects of $\SSet_{/X}$, assume that the pullback of $w$ along every $x \co \Delta[n] \rightarrow X$ is a weak equivalence and show that $w$ is also equivalence.  We do so using~\cite[\S 2.5.7]{henry2018wms}, and show that $w$ has the weak right lifting property against all $i_n \co \partial \Delta[n] \rightarrow \Delta[n]$. So let us consider the diagram
\begin{equation}
\label{equ:before-pullback}
\begin{gathered}
\xymatrix{\partial \Delta[n] \ar[rr] \ar[d] & & A_1 \ar[d]^w \\
\Delta[n] \ar[rr] \ar[dr]_{x}
 & & A_2 \ar[dl] \\
& X \, .&}  
\end{gathered}
\end{equation}
By pulling back everything to $\Delta[n]$ we obtain the diagram
\begin{equation}
\label{equ:after-pullback}
\begin{gathered}
\xymatrix{
\partial \Delta[n] \ar[r] \ar[d] & A_1 \times_X \Delta[n] \ar[d]^{x^*(w)} \\
\Delta[n] \ar[r] & A_2 \times_X \Delta[n]  \, .
} 
\end{gathered}
\end{equation}
By assumption $x^*(w)$ is a weak equivalence between fibrant objects hence it has the weak right lifting property against $i^n \co \partial \Delta[n] \rightarrow \Delta[n]$. A weak diagonal filler for~\eqref{equ:after-pullback} then gives  a weak diagonal filler for~\eqref{equ:before-pullback}, as required.
\end{proof}



\begin{proposition} \label{thm:fibrancy-of-u} \hfill 
\begin{enumerate}[(i)]
\item The map $(s, t) \co \mathsf{Weq}(\U) \rightarrow \U \times \U$ is a fibration.
\item The map $t \co \mathsf{Weq}(\U) \rightarrow \U$ is a trivial fibration.
\item The simplicial sets $\U$ and $\mathsf{Weq}(\U)$ are fibrant.
\end{enumerate}
\end{proposition}

\begin{proof}
\leavevmode
\begin{enumerate}[(i)]
\item First, we observe that $\U^{\rightarrow}$ is exactly $\Pi_p(\UU \times \UU)$, 
where $p \co \UU \times \U \rightarrow \U \times \U$ is the evident map. 
It follows from \cref{cor:Pi_types_are_fibrant} that $\U^{\rightarrow} \rightarrow \U \times \U$ is a fibration.
More precisely, \cref{cor:Pi_types_are_fibrant} implies that any pullback of  $\U^{\rightarrow} \rightarrow \U \times \U$ to a cofibrant
$X \rightarrow \U \times \U$ is a fibration (due to the cofibrancy assumption of  \cref{cor:Pi_types_are_fibrant}),
but this is sufficient to prove that $\U^{\rightarrow} \rightarrow \U \times \U$ is a fibration,
as in the argument for part~(i) of  \cref{thm:universe-u}.

We can then prove the claim in part~(i) as follows. 
Let $f \co Y \to X$ be a trivial cofibration between cofibrant objects and consider the diagram
\[ 
\xymatrix@C=1.5cm{ Y \ar[d]_f \ar[r]^-{w} & \mathsf{Weq}(\U) \ar[d] \\
X \ar[r]_-{a} & \U^{\rightarrow} }
\]
\caution{The map on the right-hand side is a monomorphism}, so a lifting is unique if it exists. It exists if the map $\bar{w}$ in $\SSet_{/X}$ classified by $w$ is a weak equivalence. 
\caution{But its pullback $f^*(\bar{w})$  in the diagram}
\[ 
\xymatrix{ 
f^*(A_1) \ar[d]_{f^*(w)}  \ar[r]  & A_1 \ar[d]^{w} \\
f^*(A_2) \ar[r] \ar[d]   & A_2 \ar[d] \\
Y \ar[r]_f & X }
\]
\caution{is a weak equivalence}.
Since the maps $p_i \co A_i \rightarrow X$ (for $i = 1, 2$) are fibrations with cofibrant domain, \cref{prop:Frobenius} implies that pullbacks of trivial cofibration between cofibrant objects 
\caution{along such 
a map} are trivial cofibrations. This implies that all the horizontal maps of the diagram above are weak equivalence, and so the upper right map also is. This shows that~$\mathsf{Weq}(\U) \rightarrow \U^{\rightarrow} \rightarrow \U \times \U$ is a fibration.
\item We prove that $t \co  \mathsf{Weq}(\U) \to \U$ has the right lifting property with respect
to all cofibrations. So let $f \co Y \rightarrow X$ be a cofibration and consider the diagonal
filling problem
\[
\xymatrix{Y \ar[d]_f \ar[r] & \mathsf{Weq}(\U) \ar[d] \\
X \ar[r] \ar@{.>}[ur]  & \U 
}
\]
By  \cref{prop:Weq_classify_Weq}, this corresponds exactly to a diagram as in the equivalence extension property as in \cref{Prop:Homotopy_ext_prop}. Indeed, the map $X \rightarrow \U$ gives us
$p \co A \to X$, the composite of~$Y \rightarrow  \mathsf{Weq}(\U)$ with the first projection
gives us $q \co B \to Y$, while the rest of the data and the commutativity of the square 
gives us a weak equivalence $u$ between $B$ and $A[f]$ over~$X$. The completion of this diagram claimed by \cref{Prop:Homotopy_ext_prop} is exactly what one needs to produce the required diagonal filler.
\item Given the first two parts of the proposition, it is sufficient to show that $\U$ is fibrant. Since
$(s, t) \co \mathsf{Weq}(\U) \rightarrow \U \times \U$ is a fibration, for any cofibrant 
simplicial set $X$,  maps $a_1 \, , a_2 \co X \rightrightarrows \U$ and homotopy $h \co \Delta[1] \times X \rightarrow \U$ from $a_1$ to $a_2$, there is a weak equivalence in $\SSet_{/X}$ between the objects classified by $a_1$ and $a_2$, constructed as follows. For this, we first consider a diagonal filler in the
diagram
\[
\xymatrix{ X \ar[r]^{i_1} \ar[d]_{\delta^0} & \mathsf{Weq}(\U) \ar@{->>}[d] \\
\Delta[1] \times X \ar[r]_{(a_1,h)} \ar@{.>}[ur] & \U \times \U
}
\]
Here, $i_1$ denotes a map classifying the identify of the object classified by $a_1$. By $a_1$ in the first component of the bottom arrow we mean the composite $\Delta[1] \times X \rightarrow X \rightarrow \U$. Composing the dotted arrow with $\delta^1$ gives us a map $X \rightarrow  \mathsf{Weq}(\U)$ whose projection to~$\U \times \U$ if $(a_1,a_2)$, \ie it classifies a weak equivalence between the objects classified by $a_1$ and $a_2$. One can do the same thing with $\delta^0$ and $\delta^1$ exchanged to get a weak equivalence in the other direction.


We can now prove that $\U$ is fibrant. A map $h^k_n \co \Lambda^k[n] \rightarrow \U $ classifies a fibration $q \co B \rightarrow \Lambda^k[n]$ with cofibrant domain. As proved in \cref{lemma:genTcof_strongHequiv}, the horn inclusions $h^k_n \co \Lambda^k [n] \rightarrow \Delta[n]$ are strong $k$-oriented homotopy equivalence and so this diagram can be extended by the retract diagram, where the precise maps depend on whether $k<n$ or $0 < k$,
\[
\xymatrix{\Lambda^k[n] \ar[d] \ar[r] & \big( \Delta[1] \times \Lambda^k[n] \big) \cup \Delta[n] \ar[d] \ar[r] & \Lambda^k[n] \ar[d]  \\
\Delta[n] \ar[r] & \Delta[1] \times \Delta[n] \ar[r] & \Delta[n] \, .
}\]
By the observation above, the composite map $\big( \Delta[1] \times \Lambda^k[n]  \big) \cup \Delta[n] \rightarrow \U$ in the diagram gives a solid diagram of the form
\[ 
\xymatrix{
  B
  \ar@{.>}[rr]
  \ar[dr]
  \ar@{->>}[dd]
&&
  \bar{B}
  \ar@{.>}[dr]
  \ar@{.>>}[dd]|{\hole}
&\\&
  A'
  \ar[rr]
  \ar@{->>}[dl]
&&
  A
  \ar@{->>}[dl]
\\
  \Lambda^k[n]
  \ar[rr]_{h^k_n}
&&
  \Delta[n]
&
}
\] 
So one can construct a fibration  $\bar{q} \co \bar{B} \to \Delta[n]$ with cofibrant domain whose pullback 
along~$h^k_n$ is isomorphic to $q \co B \to \Lambda^k_n$. The map $b \co \Delta[n] \rightarrow \U$ classifying $\bar{q}$ gives the lift we are looking for. More precisely, one can use $q  \co \bar{B} \to
\Delta[n]$ to construct  a map $b \co \Delta[n] \rightarrow \U$ which extend the one we started from and which classifies something isomorphic to $\bar{B}$. \qedhere
\end{enumerate}
\end{proof}



\begin{corollary} \label{thm:univalence-of-u}
The fibration $\pi \co \UU \to \U$ is univalent.
\end{corollary}

\begin{proof} Let $\delta \co \U \to \U \times \U$ be the diagonal map of $\U$ and consider its factorisation
as a trivial cofibration $r \co \U \to \mathsf{Id}_\U$ followed by a fibration $(s,t) \co \mathsf{Id}_\U \to \U \times \U$. The evident solid diagram
\[
\xymatrix@C=1.5cm{
\U \ar[r] \ar[d]_r & \Weq(\U) \ar[d]^{(s,t)} \\
\mathsf{Id}_\U \ar[r]  \ar@{.>}[ur]_{j} &  \U \times \U }
\]
has a dotted diagonal filler $j$, since $r$ is a trivial cofibration and $t$ is a fibration by~\cref{thm:fibrancy-of-u}. The univalence of $\pi$ is the claim that $j$ is a weak equivalence. But by the 3-for-2 property applied to the diagram
\[
\xymatrix{
\U  \ar[rr]^-{j} \ar[dr]_{1_\U} & &   \Weq(\U)  \ar[dl]^t \\
 & \U & }
\]
this happens if and only if $t$ is a weak equivalence. This amounts to $t$ being a trivial
fibration, which holds by part~(ii) of~\cref{thm:fibrancy-of-u}. 
\end{proof} 





\bigskip

We now come to the second step of our construction of the required fibration $\pi_c \co \UU_c \to \U_c$.
This will have not only all the properties of $\pi \co \UU \to \U$ established earlier, but also a bifibrant base.  In order to do this, let $\U_c$ be a cofibrant replacement of~$\U$,  which comes with a trivial fibration
\begin{equation}
\label{equ:ucu}
\tau \co \U_c \rightarrow \U \, .
\end{equation}
Since $\U$ is fibrant, as shown in part~(iii) of~\cref{thm:fibrancy-of-u}, the simplicial set $\U_c$ is not only cofibrant but also fibrant. We then define $\UU_c$ via the pullback
\[
\xymatrix{
\UU_c \ar[d]_{\pi_c} \ar[r] \drpullback & \UU \ar[d]^{\pi}  \\
\U_c \ar[r]_\tau & \U}
\]
We now prove that $\pi_c \co \UU_c \to \U_c$ inherits from $\pi \co \UU \to \U$ the properties
established in this section. The next proposition is the counterpart of~\cref{thm:universe-u}. 


\begin{proposition} \label{thm:universe-uc} 
\hfill 
\begin{enumerate}[(i)] 
\item $\pi_c \co \UU_c \to \U_c$ is a small fibration between cofibrant objects. 
\item For any map $a \co X \rightarrow \U_c$ with $X$ cofibrant, the 
simplicial set $A$ given by the pullback
\[
\xymatrix{
A \ar[r] \ar[d]_p & \UU_c \ar[d]^\pi \\
X \ar[r]_a & \U_c }
\]
is cofibrant.
\item The map $\pi_c \co \UU_c \to \U_c$ weakly classifies small fibrations between cofibrant objects, \ie 
for every small fibration $p \co A \to X$ with $X$ and $A$ cofibrant there exists a pullback diagram of the form
\[
\xymatrix{
A \ar[r] \ar[d]_p & \UU_c \ar[d]^{\pi_c} \\
X \ar[r]_a & \U_c }
\]
\end{enumerate}
\end{proposition}

\begin{proof} \hfill
\begin{enumerate}[(i)] 
\item $\U_c$ is cofibrant by construction and the rest of the claim follows from part~(ii) of~\cref{thm:universe-u}. 
\item This follows from the cofibrancy of $X$ and $\UU_c$ by~\cref{lem:cofibrant_fiber_product}.
\item Let $p \co A \to X$ be a small fibration with $X$ cofibrant. Since $p$ is a
small fibration, we know 
from part~(iii) of \cref{thm:universe-u} that there is a pullback diagram of the form 
\[
\xymatrix{
A \ar[r] \ar[d]_p \drpullback & \UU \ar[d]^{\pi} \\
X \ar[r]_a & \U }
\]
Since $X$ is cofibrant, we have a diagonal filler in the diagram
\[
\xymatrix{
0 \ar[r] \ar[d] & \U_c \ar[d]^{\tau} \\
X \ar[r]_a \ar@{.>}[ur] & \U }
\]
which shows that the map $a \co X \to \U$ factors via $\U_c$.  We then obtain the diagram
\[
\xymatrix{
A \ar[r] \ar[d]_p &  \UU_c \ar[r]  \ar[d]^{\pi_c} \drpullback & \UU \ar[d]^{\pi} \\
X \ar[r]_{a_c} & \U_c \ar[r]_{a} &  \U }
\]
Here, the right-hand side square and the rectangle are pullbacks and therefore the left-hand
side square is also a pullback, as required. \qedhere
\end{enumerate} 
\end{proof} 


\begin{proposition} \label{thm:fibrancy-of-uc} \hfill 
\begin{enumerate}[(i)]
\item The map $(s, t) \co \mathsf{Weq}(\U_c) \rightarrow \U_c \times \U_c$ is a fibration.
\item The map $t \co \mathsf{Weq}(\U_c) \rightarrow \U_c$ is a trivial fibration.
\item  $\U_c$ is bifibrant and $\mathsf{Weq}(\U_c)$ is fibrant.
\end{enumerate}
\end{proposition}

\begin{proof} \noten{Maybe this helps?}

\notesh{
 Fibrancy should follow directly from equivalence extension property, without using `composition vs filling' but rather retract property for horns (see notes).
Once we have established fibrancy of $U_c$, then one can prove univalence by showing that 
 $t \co \mathsf{Weq}(U_c) \to U_c$ is a trivial fibration. 
Question: do we need to know that $\mathsf{Weq}(\U_c)$ is a cofibrant object to get univalence?  I'm  relatively sure $\mathsf{Weq}(\U_c)$ is not cofibrant. But all these property proved here will imediately pass to any cofibrant replacement. This is also why I'm working with  $\mathsf{Weq}(\U)$ instead: everything will be pulled back to the version for $\U_c$.
}

\end{proof}


\begin{corollary} \label{thm:univalence-of-uc}
The fibration $\pi_c \co \UU_c \to \U_c$ is univalent.
\end{corollary}

\begin{proof} This follows from part (ii) of~\cref{thm:fibrancy-of-uc} exactly in the 
same way as \cref{thm:univalence-of-u} follows from by part~(ii) of~\cref{thm:fibrancy-of-u}. 
\end{proof}

\bigskip


% \input{appendix-cofibrant-replacement}





\bibliographystyle{plain}
\bibliography{../Auxiliary/bibliography}

\end{document}




\section{Univalence (Obsolete)}

\notesh{[Work in progress] I prefer to start again this section from scratch, but I'm leaving the old univalence section as long as this is not finished}



Let $p:E \twoheadrightarrow B$ be any fibration with $E$ and $B$ bifibrant. There is a factorization of the diagonal map $B \rightarrow E^{\to} \twoheadrightarrow B \times B$ where $E^{\to} \twoheadrightarrow B \times B$ is the canonical map, which (by the universal property of $E^{\to}$) corresponds to the identity of $E=E[id_B] \rightarrow E[id_B]$. As the identity is a weak equivalence, \cref{lem:isEquiv2} above implies that this maps factors into $B \rightarrow Weq(E) \twoheadrightarrow E \times E$.

In particular, using the lifting:

\[
\xymatrix{
B \ar@{^{(}->}[d]^{\sim} \ar[r] & Weq(E) \ar@{->>}[d] \\
\Id_B \ar@{->>}[r] \ar@{..>}[ur] & B \times B \\ 
}
\]

one obtains a map $\Id_B \rightarrow Weq(E)$.

\begin{definition} \label{def:univalentFib}
A Fibration $p:E \twoheadrightarrow B$ between bifibrant objects is said to be univalent if the map $\Id_B \rightarrow Weq(E)$ is an equivalence.
\end{definition}

This is clearly equivalent to the fact that the map $B \rightarrow Weq(E)$ is an equivalence, or to the fact that any of the two projection $Weq(E) \twoheadrightarrow B$ is a trivial fibration.

In the case of the fibration $\UU_c \rightarrow \U_C$ this exactly corresponds to the usual formulation of univalence in type theory.


\begin{proposition}
$\U$ is fibrant.
\end{proposition}

\begin{proof}

TODO
\end{proof}

\begin{proposition}
The fibration $\UU_C \twoheadrightarrow \U_c$ is univalent.
\end{proposition}

\notesh{This assumes $\UU_c \twoheadrightarrow \U_c$ is a fibration between bifibrant objects.}

\begin{proof}

As observed just after \cref{def:univalentFib} it is enough to show that the target projection $ Weq(\UU_c) \twoheadrightarrow \U_c$ is a weak equivalence. Consider a diagram:

\[ \xymatrix{
Y \ar@{^{(}->}[d]_{f} \ar[r]^{\beta} & Weq(\UU_c) \ar@{->>}[d] \\
X \ar[r]^{\alpha} & \U_c
}
\]

where $f$ is any cofibrations between $Y$ and $X$ two bi-fibrants objects. We will show that there exists a diagonal filling making the diagram commutes up to homotopies. This is sufficient to show $Weq(\UU_c) \rightarrow \U_c$ is invertible in the homotopy category, hence is a weak equivalence.

The map to $\alpha$ corresponds to a fibration $A \twoheadrightarrow X$ with $A$ cofibrant, and the map $\beta$ gives in particular a (solid) diagram as in \cref{Prop:Homotopy_ext_prop}:

\[ 
\xymatrix{
 B
  \ar@{.>}[rr]
  \ar[dr]^{u}
  \ar[dd]_(.3){q}
&&
  \bar{B}
  \ar@{.>}[dr]^{v}
  \ar@{.>}[dd]_(.3){\bar{q}}|{\hole}
&\\&
  A[f] 
  \ar[rr]
  \ar[dl]
&&
  A
  \ar[dl]^{p}
\\
  Y
  \ar[rr]_{f}
&&
  X
&
}
\]

which hence (by \cref{Prop:Homotopy_ext_prop}) admit a dotted extention where both square are pullbacks.

This filling in turn allows us to construct a map $X \rightarrow Weq(\UU_c)$ that makes the lower triangle commutes. The upper triangle does not quite commute though, one only have that the composite with $Weq(\UU_c) \twoheadrightarrow \UU^{\to}_c$ commutes ``up to isomorphisms'' in the sense that the two maps $Y \rightrightarrows \UU^{\to}_c$ classifies arrows in $\BFFib_{/Y}$ that are isomorphic.

Hence the two maps $Y \rightrightarrows \UU^{\to}_c$ are homotopic.

\notesh{This is probably not very hard to prove, but I'm not sure what is the best way to do that... In the worst case scenario one can construct a homotopy explicitely, though that sounds tedious. This has probably been delt with in previous work on the topics ? }


Now, for $Y$ a bifibrant object two maps $Y \rightrightarrows Weq(\UU_c)$ whose image in $\UU^{\to}_c$ are homotopic are also homotopic which concludes the proof that one has a diagonal map making the two triangles commutes up to homotopy. To prove the last claim consider a bifibrant interval object $Y \coprod Y \hookrightarrow IY \overset{\sim}{\twoheadrightarrow} Y$. Given a diagram of the form:


\[\xymatrix{Y \coprod Y \ar@{^{(}->}[d] \ar[r] & Weq(\UU_c) \ar@{->>}[d] \\
I Y \ar[r] & \UU_c^{\to} \\
}
\]

One needs to construct a diagonal lift. One forms the successible pullback $P_1$ and $P_2$:

\[\xymatrix{P_2 \ar[r] \ar@{->>}[d] & P_1 \ar@{->>}[d] \ar[r] & Weq(\UU_c) \ar@{->>}[d] \\
Y \ar[r]^{\sim} & I Y \ar[r] & \UU_c^{\to} \\
}
\]

The map $P_2 \rightarrow Y$ is a trivial fibration, because it is of the form $\texttt{isEquiv}_Y( \_) \twoheadrightarrow Y$ and it has a section. The map $P_1 \rightarrow P_2$ is a weak equivalence as a pullback of a weak equivalence between fibrant objects along a fibrations. This implies that the map $P_1 \twoheadrightarrow IY$ is a trivial fibration, and this is sufficient to construct a diagonal lift in the initial diagram.


\end{proof}



Let $p:E \twoheadrightarrow B$ be any fibration. We want to define what it means for $p$ to be a univalent fibration, and show that $\UU \twoheadrightarrow \U$ and $\UU_c \twoheadrightarrow \U_c$ are univalent fibrations.

Using the ``$\Pi$-types'' that we have already defined, one can to construct a fibration $E^{\to} \twoheadrightarrow B \times B$ that classifies morphisms between two fibers of $p$. More precisely, $E^{\to}$ is defined as $\Pi_{p \times Id_B}(E \times E)$ in:

\[
\xymatrix{
E \times E \ar[d]_{Id_E \times p } & \Pi_{p \times Id_B}(E \times E) \ar[d] \\
E \times B \ar[r]_{p \times id_B} & B \times B \\
}
\]

A morphisms from any object $A$ to $E^{\to}$ is the same as a morphism $A \overset{(f,g)}{\rightarrow} B \times B$ together with a morphism $E[f] \rightarrow E[g]$ over $A$. We now need to construct an object $Weq(p) \twoheadrightarrow E^{\to}$ that similarly classifies ``weak equivalences'' $E[f] \overset{\sim}{\rightarrow} E[g]$. we have not been able to show constructively that weak equivalences are stable under pullback along fibrations, so it is not clear if such an object $Weq(p)$ can be defined as a subobject od $E^{\to}$ or not. Instead we will follow Voevodsky's definition from type theory, see also section $4$ of \cite{shulman:reedy}, and hence one needs to start by discusing the type $\texttt{isContr}_B(E)$

\begin{definition}

Given a fibration $p:E \twoheadrightarrow B$ one defines:

\[ \texttt{isContr}_B(E) = \Sigma_p \Pi_{\pi_2} \Id_E  \]


With $Id_E \twoheadrightarrow E \times_B E$ and $\pi_2: E \times_B E \rightarrow E$.

\end{definition}

So $\texttt{isContr}_B(E)$ is a fibration over $B$ which encodes the idea that the fiber of $p$ is contractible, in the sense that the data of an ``element'' of $\texttt{isContr}_B(E)$ over a $b \in B$ is given by an element $e \in E(b)$ and for all $e' \in E(b)$ a path between $e$ and $e'$.

We now need to use this to construct an object that classifies weak equivalences. Assume one has two fibrations $E_1,E_2 \twoheadrightarrow B$ and a morphism $f$:


\[\xymatrix{
E_1 \ar@{->>}[dr] \ar[rr]^f & & E_2 \ar@{->>}[dl] \\
& B & 
}\]

We can then form the ``homotopy fiber'' of $f$ as the pullback:

\[\xymatrix{
P f \ar@{->>}[d] \ar[r]  & \Id_{E_2} \ar@{->>}[d] \\
E_1 \times_B E_2 \ar[r] & E_2 \times_B E_2 
}\]

Which as usual produces a factorization of $f$:

\[E_1 \rightarrow Pf \twoheadrightarrow E_2 \]

\begin{lemma}
If $E_1$ and $E_2$ are cofibrant and $E_2 \rightarrow B$ is a fibration, then $E_1 \rightarrow Pf$ is a weak equivalence.
\end{lemma}

\begin{proof}
The projections $\Id_{E_2} \twoheadrightarrow E_2$ are trivial fibrations because of point (iv) of \cref{proposition:MainPathObject:IdBifib} (the proof of this claims only uses that $A \twoheadrightarrow X$ is a fibration, and none of the other assumptions, so it applies here), so the pullback $Pf \rightarrow E_1$ is also a trivial fibration. $\Id_{E_2}$ is cofibrant because because of (i) of \cref{proposition:MainPathObject:IdBifib} (which only uses that $E_2$ is cofibrant) so $Pf$ is cofibrant by \ref{lem:cofibrant_fiber_product} as $E_1$ and $E_2$ are cofibrant.

It follows by \cref{lemma:triv_fib_are_we} that $Pf \rightarrow E_1$ is a weak equivalence. By $2$-out-of-$3$ for weak equivalences, $E_1 \rightarrow Pf$ is a weak equivalence.

\end{proof}


One can then define:

\begin{definition} For any morphisms $f$ in $\Fib/B$ one defines:

\[ \texttt{isEquiv}_B(f) = \Pi_{p_2} \texttt{isContr}_B(Pf) \]

where $p_2$ is the fibration $E_2 \twoheadrightarrow B$.

Given $p:E \twoheadrightarrow B$ be any fibration, one defines

\[ Weq(E) = \texttt{isEquiv}_{E^{\to}}(f) \]

Where $f$ denotes the universal map over $E^{\to}$ corresponding to its universal property.

\end{definition}

The definition of $\texttt{isEquiv}$ formalize the idea that $f$ is an equivalence if and only all its homotopy fiber are contractible.

Admiting that the $\Pi$-types and identity types that we have defined so far are indeed part of an interpretation of type theory, i.e. that the coherence problems can be solved, these exactly corresponds to the usual definition of these notion in homotopy type theory. We now need some lemmas showing that these definitions indeed behave as expected in our model theoretic settings. These lemma mostly comes from section 4 of \cite{shulman:reedy}, though we need to reprove them to track where fibrancy/cofibrancy assumptions are needed for the proof to carry over.

\begin{lemma}\label{lem:IsContr1}For a fibration $p:E \twoheadrightarrow B$ with $E$ and $B$ bifibrant, the following are equivalent:

\begin{enumerate}[(i)]
\item The map $p:E \twoheadrightarrow B$ is a trivial fibration.
\item The map $\texttt{isContr}_B (E) \twoheadrightarrow B$ has a section.
\item There is a map $ 1 \rightarrow \Pi_B  \texttt{isContr}_B (E) $.
\item The map $\texttt{isContr}_B (E) \twoheadrightarrow B$ is a trivial fibration.
\end{enumerate}

\end{lemma}



More precisely, (ii) implies that $p$ is a weak equivalence assuming either that $B$ is fibrant or that $E$ and $B$ are cofibrant, so (ii) $\Rightarrow$ (i) when $B$ is fibrant, (i) $\Rightarrow$ (ii) when $B$ is cofibrant and $E$ is bifibrant.
(ii) $\Leftrightarrow$ (iii) holds without assumption on $E$ and $B$, (vi) $\Rightarrow$ (ii) holds as soon as $B$ is cofibrant. And finally (i) $\Rightarrow$ (vi) holds when $E$ is bifibrant. 

\begin{proof}

A section of $\texttt{isContr}_B (E) \twoheadrightarrow B$ is by definition of $\texttt{isContr}_B (E)$ the data of a section $s:B \rightarrow E$, and a map $h \co E \to \Id_E$ whose image by $\Id_E \twoheadrightarrow E \times_B E$ is $(s \circ p, id_E)$. Such a section $s$ and homotopy $h$ produces a homotopy invers to $p$ and hence implies that $p$ is a weak equivalences, and hence a trivial fibration as $B$ is assumed fibrant.  This proves (ii) $\Rightarrow$ (i).

Note that if one only assume that $E$ and $B$ are cofibrant and $p$ is a fibration, it is still the case that $\Id_E \twoheadrightarrow E$ is a trivial fibration between cofibrant objects, hence a weak equivalence. Which is hence sufficient to show that the map $h$ induce an equality in the homotopy category between $s \circ p $ and the identity of $E$.


Conversely, assuming (i), one can construct a section $s$ as above using the lifting property of $B$ (cofibrant) against $p$. To construct the homotopy $h$ one needs to use a lifting property of $E$ against the map $Id_E \twoheadrightarrow E \times_B E$, which is a trivial fibrations because $\Id_E \twoheadrightarrow E$ and $E\times_B E \twoheadrightarrow E$ both are and trivial fibrations satisfies $2$-out-of-$3$ among fibrations between fibrant objects.

The equivalence between (ii) and (iii) follows from the universal property of $\Pi$-types.
The implication (vi) $\Rightarrow$ (ii) is clear when $B$ is cofibrant. We conclude by showing (i) $\Rightarrow$ (vi) 

As above, as $E$ is fibrant, one can deduce assuming (i) that $\Id_E \twoheadrightarrow E \times_B E$ is a trivial fibration. $\pi_2 : E \times_B E \twoheadrightarrow E$ is a fibration with cofibrant domain, hence $\Pi_{\pi_2} \Id_E \rightarrow E$ is a trivial fibration by \cref{cor:Pi_types_are_fibrant}, and finally, $\texttt{isContr}(E)_B \rightarrow B$ is just the composite $\Pi_{\pi_2} \Id_E \rightarrow E \rightarrow B$ so is also a trivial fibration.
\end{proof}

\begin{lemma} \label{lem:isContr2}
Let $p: E \twoheadrightarrow B$ be a fibration, and $f:A \rightarrow B$ be a morphism. Then there is a natural isomorphisms

\[ \texttt{isContr}_A(E[f]) \simeq \texttt{isContr}_B(E) [f] \]

In particular, if $E$ is cofibrant and $A$ bifibrant, then the following conditions are equivalent: 

\begin{enumerate}[(i)]

\item $E[f] \twoheadrightarrow A$ is a trivial fibration.

\item The maps $A \rightarrow B$ factors as $A \rightarrow \texttt{isContr}_B(E) \rightarrow B$.

\end{enumerate}

\end{lemma}

\begin{proof}

The stability of $\texttt{isContr}$ under pullback is a very formal property which follows from the similar stability property of $\Pi$-types, which in turn is automatic from their universal property (see for example lemma 4.2 in \cite{shulman:reedy}). The equivalence is an immediate consequence of this pullback stability and \cref{lem:IsContr1}.

\end{proof}


Similarly, one also has:

\begin{lemma} \label{isEquiv1} Let $f :E_1 \rightarrow E_2$ be an arrow in $\BFFib/B$ for $B$ bifibrant, i.e. $p_i :E_i \twoheadrightarrow B$ are fibrations and the $E_i$ are cofibrant. The following are equivalent:

\begin{enumerate}[(i)]

\item $f$ is a weak equivalence.

\item $\texttt{isEquiv}(f) \twoheadrightarrow B$ has a section.

\item There is a map $1 \rightarrow \Pi_B \texttt{isEquiv}(f)$.

\item The map $\texttt{isEquiv}(f) \twoheadrightarrow B$ is a trivial fibration.

\end{enumerate}
\end{lemma}

Note that the implication (ii) $\Rightarrow$ (i) holds without assuming that $B$ is bifibrant.

\begin{proof}

As $E_2$ is cofibrant, $Id_{E_2}$ is cofibrant as well because of point (\ref{proposition:MainPathObject:IdBifib}) of \cref{proposition:MainPathObject}. And \cref{lem:cofibrant_fiber_product} implies that as $E_1$ and $E_2$ are cofibrant, then $Pf$ is cofibrant as well. So as $\texttt{isEquiv}(f)$ is defined as $\Pi_{p_2}\texttt{isContr}(Pf)$ the equivalence above mostly follows from \cref{lem:IsContr1}. More precisely: 

$f$ factors as $E_1 \overset{\sim}{\rightarrow} Pf \twoheadrightarrow E_2$ so $f$ is an equivalence if and only if $Pf \twoheadrightarrow E_2$ is an equivalence, which by \cref{lem:IsContr1} is equivalent to the fact that $\texttt{isContr}(Pf) \twoheadrightarrow E_2$ has a section, which by universal property of $\Pi$-types is equivalent to condition (ii). The equivalence between (ii) and (iii) is formal exactly as in the proof of \cref{lem:IsContr1}. One still has that (iv) implies (ii) simply because $B$ is cofibrant. Assuming (i) one has that $Pf \twoheadrightarrow E_2$ is a trivial fibration, hence $\texttt{isContr}(Pf) \twoheadrightarrow E_2$ is a trivial fibration by \cref{lem:IsContr1}, and \cref{cor:Pi_types_are_fibrant} implies that $\Pi_{p_2} \texttt{isContr}(Pf) = \texttt{isEquiv}(f) \twoheadrightarrow B$ is a trivial fibration.

As observed below \cref{lem:IsContr1}, one has that a section of $\texttt{isEquiv}(f) \twoheadrightarrow B$ shows that $Pf \twoheadrightarrow E_1$ is an equivalence only assuming that $E_1$ and $E_2$ are cofibrant, so it is indeed the case that (ii) $\Rightarrow$ (i) holds without assuming $B$ is bifibrant.

\end{proof}


Similarly to \cref{lem:isContr2}, one has:
\begin{lemma} \label{lem:isEquiv2}

Let $f: E_1 \rightarrow E_2$ is a morphism in $\BFFib/B$  and $g:A \rightarrow B$ a morphism with $A$ and $B$ bifibrant. Then there is a natural isomorphisms

\[ \texttt{isEquiv}_A(f[g]) \simeq \texttt{isContr}_B(f) [g] \]

Where $f[g]$ denotes the map $E_1[g] \rightarrow E_2[g]$ obtained by pullback of $f$ 
In particular, the following conditions are equivalent: 

\begin{enumerate}[(i)]

\item $f[g]: E_1[g] \rightarrow E_2[g]$ is an equivalence.

\item The maps $g$ factors as $A \rightarrow \texttt{isEquiv}_B(f) \rightarrow B$.

\end{enumerate}
\end{lemma}


% Type theory rules

\section{Type-theoretic rules}



\subsection*{Identity types}


\[
\begin{gathered}
\begin{prooftree}
\Gamma \vdash A \co \type \qquad
\Gamma \vdash a \co A \qquad
\Gamma \vdash b \co A 
\justifies
\Gamma \vdash \mathsf{Id}_A(a,b) \co \type
\end{prooftree} \\[2ex]
\begin{prooftree}
a \co A 
\justifies
\mathsf{refl}(a) \co \mathsf{Id}_A(a,a)
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash p \co \Id_A(a,b) \qquad
\Gamma, x, y \co A, z \co \Id_A(x,y) \vdash B \co \type \qquad
\Gamma, x \co A \vdash d \co B[x/y, \mathsf{refl}(x)/z] 
\justifies
\Gamma \vdash \mathsf{J}(a,b,p,d) \co B[a/x, b/y, p/z]
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash a \co A \qquad
\Gamma, x, y \co A, z \co \Id_A(x,y) \vdash B \co \type \qquad
\Gamma, x \co A \vdash d \co B[x/y, \mathsf{refl}(x)/z] 
\justifies
\Gamma \vdash \mathsf{J}(a,a,\mathsf{refl}(a),d) = d[a/x] \co B[a/x, a/y, \mathsf{refl}(a)/z]
\end{prooftree}
\end{gathered}
\]



\subsection*{$\Sigma$-types}

\[
\begin{gathered}
\begin{prooftree}
\Gamma \vdash A \co \type \qquad
\Gamma, x \co A \vdash B \co \type
\justifies
\Gamma \vdash (\Sigma x \co A) B 
\end{prooftree}  \\[1ex]
\begin{prooftree}
\Gamma \vdash a \co A  \qquad
\Gamma \vdash b \co B[a/x] 
\justifies
\Gamma \vdash \mathsf{pair}(a,b) \co (\Sigma x \co A) B 
\end{prooftree}  \\[2ex]
\begin{prooftree}
\Gamma \vdash c \co (\Sigma x \co A) B 
\justifies
\Gamma \vdash  \pi_1(c) \co A 
\end{prooftree} \qquad
\begin{prooftree}
\Gamma \vdash c \co (\Sigma x \co A) B 
\justifies
\Gamma \vdash \pi_2(c) \co B[ \pi_1(c)/x] 
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash a \co A  \qquad
\Gamma \vdash b \co B[a/x] 
\justifies
\Gamma \vdash \pi_1 \big( \mathsf{pair}(a,b) \big)  = a \co A
\end{prooftree}  \qquad
\begin{prooftree}
\Gamma \vdash a \co A  \qquad
\Gamma \vdash b \co B[a/x] 
\justifies
\Gamma \vdash \pi_2\big( \mathsf{pair}(a,b) \big) = b \co B[a/x]
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash c \co (\Sigma x \co A) B 
\justifies
\Gamma \vdash  c = \mathsf{pair}(\pi_1(c), \pi_2(c))  \co   (\Sigma x \co A) B 
\end{prooftree}
\end{gathered}
\]







\subsection*{$\Pi$-types}
 
\[ 
\begin{gathered} 
\begin{prooftree}
\Gamma \vdash A \co \type \qquad
\Gamma, x \co A \vdash B \co \type
\justifies
\Gamma \vdash (\Pi x \co A) B 
\end{prooftree}  \\[2ex]
\begin{prooftree}
\Gamma, x \co A \vdash b \co B
\justifies
\Gamma \vdash (\lambda x \co A) b \co (\Pi x \co A) B 
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash f \co (\Pi x \co A) B \quad
\Gamma \vdash a \co A 
\justifies
\Gamma \vdash \mathsf{app}(f,a) \co B[a/x]
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma, x \co A \vdash b \co B \qquad
\Gamma \vdash a \co A 
\justifies
\Gamma \vdash \mathsf{app}( (\lambda x \co A)b, a) = b[a/x] \co B[a/x] 
\end{prooftree} \\[2ex]
\begin{prooftree}
\Gamma \vdash f \co (\Pi x \co A) B 
\justifies
\Gamma \vdash \eta_f \co \Id_{(\Pi x \co A)B} \big( f, (\lambda x \co A) \mathsf{app}(f,x)\big)
\end{prooftree}
\end{gathered}
\]






\subsection*{Universe type}


\[
\U \co \type \qquad 
\begin{prooftree}
\Gamma \vdash a \co \U
\justifies
\Gamma \vdash \mathsf{T}(a) \co \type
\end{prooftree}
\]

\appendix


